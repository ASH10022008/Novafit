<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaFit Tracker - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            transition: background-color 0.5s, color 0.5s; /* Smooth transition for theme change */
        }
        /* --- Dark Mode Styles (Default) --- */
        .neon-gradient {
            background: linear-gradient(135deg, #0f172a, #7e22ce, #06b6d4);
            background-size: 600% 600%;
            animation: gradientShift 16s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- NEW: Particle System Styles --- */
        #particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: -1; /* Place behind the main dashboard content */
        }

        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.5);
            opacity: 0;
            animation: 
                flow linear infinite,
                fade ease-in-out infinite;
        }

        @keyframes flow {
            0% { transform: translate(0, 0); }
            /* Uses CSS variable set by JS for random direction */
            100% { transform: translate(var(--flow-x), var(--flow-y)); } 
        }

        @keyframes fade {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.8; }
        }

        /* --- Neon Border 3D Effect for Main Container --- */
        .neon-border-3d {
            border: 1px solid rgba(126, 34, 206, 0.3); /* Thin border to frame the shadow */
            box-shadow: 
                /* Inner shadow for "depth" */
                inset 0 0 10px rgba(126, 34, 206, 0.5), /* purple inner glow */
                /* Outer shadow for primary neon glow */
                0 0 20px rgba(126, 34, 206, 0.7), /* purple glow */
                /* Outer shadow for secondary/offset glow (creates 3D/lifted effect) */
                0 8px 30px rgba(6, 182, 212, 0.5); /* cyan offset glow */
        }

        /* Custom style for the circular progress bar */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        /* Style for the current view and active nav link */
        .view-section:not(.active) {
            display: none;
        }
        .nav-link.active {
            box-shadow: 0 0 15px rgba(126, 34, 206, 0.7);
            background-color: rgba(126, 34, 206, 0.2);
            color: #d8b4fe; /* purple-300 */
        }
        
        /* --- CRITICAL FIX: Select box styles --- */
        
        /* Text/Number/Date inputs use dark text on light gray */
        input[type="number"], input[type="text"], input[type="date"] {
            background-color: #f3f4f6; /* Light Gray Background */
            border: 1px solid #d1d5db; /* Light Gray Border */
            color: #1f2937; /* Dark Gray/Black Text */
        }
        
        /* NEW FIX: Select box uses high-contrast colors (White text on Dark Blue background) 
           to fight OS overrides for the selected value. */
        select {
            background-color: #334155; /* Dark Blue Background */
            border: 1px solid #d1d5db; /* Light Gray Border (Matches input border) */
            color: #ffffff; /* White Text - HIGH CONTRAST */
            font-weight: 600; 
        }

        /* Ensure options in select boxes are clearly visible (white text on dark background) 
           when the dropdown is open. */
        select option {
            color: #ffffff; /* White text for contrast in dropdown list */
            background-color: #1f2937; /* Dark background for the options list */
            font-weight: normal; /* Reset font weight for the options themselves */
        }
        
        input:focus, select:focus {
            border-color: #7e22ce; /* purple-700 */
            outline: none;
            box-shadow: 0 0 0 2px rgba(126, 34, 206, 0.5);
        }
        /* Style for the calculated (read-only) field */
        .calculated-display {
            background-color: rgba(6, 182, 212, 0.1); /* light blue tint */
            border: 1px solid rgba(6, 182, 212, 0.5); 
            color: #22d3ee; /* cyan-400 */
        }
        /* Custom scrollbar for better look in dark mode */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="neon-gradient text-gray-100 p-4 sm:p-8">

    <div id="particles-container"></div>

    <div id="status-message" class="fixed top-4 right-4 z-50 transition-opacity duration-300 ease-in-out opacity-0">
        </div>

    <div class="max-w-7xl mx-auto backdrop-blur-sm bg-gray-900/70 p-4 sm:p-8 rounded-3xl shadow-2xl space-y-8 neon-border-3d">
        <header class="flex flex-col sm:flex-row justify-between items-center pb-6 border-b border-gray-700/50">
            <h1 class="text-3xl font-extrabold text-purple-400">
                NovaFit Tracker 
                <span id="active-profile-display" class="text-base font-normal text-cyan-300 block sm:inline-block mt-1 sm:mt-0"></span>
            </h1>
            <nav class="mt-4 sm:mt-0 flex space-x-2 sm:space-x-4">
                <button id="nav-dashboard" data-view="dashboard-view" class="nav-link px-4 py-2 rounded-full text-sm font-medium hover:bg-purple-700/30 transition active">Dashboard</button>
                <button id="nav-analytics" data-view="analytics-view" class="nav-link px-4 py-2 rounded-full text-sm font-medium hover:bg-purple-700/30 transition">Analytics</button>
                <button id="nav-log" data-view="log-activity-view" class="nav-link px-4 py-2 rounded-full text-sm font-medium hover:bg-purple-700/30 transition">Log Activity</button>
                <button id="nav-goals" data-view="goals-view" class="nav-link px-4 py-2 rounded-full text-sm font-medium hover:bg-purple-700/30 transition">Goals</button>
                <button id="nav-profile" data-view="profile-view" class="nav-link px-4 py-2 rounded-full text-sm font-medium hover:bg-purple-700/30 transition">Profile</button>
            </nav>
        </header>

        <section id="profile-view" class="view-section">
            <h2 class="text-2xl font-semibold mb-6 text-purple-300">Profile Management</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="bg-gray-800/50 p-6 rounded-xl shadow-inner border border-purple-500/30">
                    <h3 class="text-xl font-bold mb-4 flocked text-purple-300">Create New Profile</h3>
                    <form id="create-profile-form">
                        <label for="new-profile-name" class="block text-sm font-medium text-gray-300 mb-2">Profile Name</label>
                        <input type="text" id="new-profile-name" name="name" required class="w-full p-3 rounded-lg mb-4" placeholder="e.g., Jane's Fitness">
                        
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label for="new-profile-weight" class="block text-sm font-medium text-gray-300 mb-2">Weight (kg)</label>
                                <input type="number" id="new-profile-weight" name="weight" min="1" step="0.1" required class="w-full p-3 rounded-lg" placeholder="e.g., 70.5">
                            </div>
                            <div>
                                <label for="new-profile-height" class="block text-sm font-medium text-gray-300 mb-2">Height (cm)</label>
                                <input type="number" id="new-profile-height" name="height" min="1" required class="w-full p-3 rounded-lg" placeholder="e.g., 175">
                            </div>
                            <div>
                                <label for="new-profile-gender" class="block text-sm font-medium text-gray-300 mb-2">Gender</label>
                                <select id="new-profile-gender" name="gender" required class="w-full p-3 rounded-lg">
                                    <option value="" disabled selected>Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other/Prefer not to say</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold transition shadow-lg shadow-purple-600/50">Create & Log In</button>
                    </form>
                </div>

                <div id="active-profile-details" class="bg-gray-800/50 p-6 rounded-xl shadow-inner border border-green-500/30">
                    <h3 class="text-xl font-bold mb-4 text-green-300">Currently Active Profile</h3>
                    <div id="current-profile-info" class="text-lg text-gray-300 space-y-2">
                        <p>Please create or select a profile.</p>
                    </div>
                    <p class="text-gray-400 mt-4">Total Activities Logged: <span class="font-mono text-green-400" id="current-profile-activity-count">0</span></p>
                </div>
            </div>
            
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4 text-orange-300">Update Profile Details</h3>
                <form id="update-profile-form" class="max-w-xl mx-auto bg-gray-800/50 p-6 rounded-xl shadow-inner border border-orange-500/30">
                    <p id="update-profile-status" class="text-center text-gray-500 mb-4">Please log in to update your profile.</p>
                    <div id="update-profile-fields" class="hidden">
                        
                        <label for="update-profile-name" class="block text-sm font-medium text-gray-300 mb-2">Profile Name</label>
                        <input type="text" id="update-profile-name" name="name" required class="w-full p-3 rounded-lg mb-4" placeholder="Name">
                        
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div>
                                <label for="update-profile-weight" class="block text-sm font-medium text-gray-300 mb-2">Weight (kg)</label>
                                <input type="number" id="update-profile-weight" name="weight" min="1" step="0.1" required class="w-full p-3 rounded-lg" placeholder="Weight">
                            </div>
                            <div>
                                <label for="update-profile-height" class="block text-sm font-medium text-gray-300 mb-2">Height (cm)</label>
                                <input type="number" id="update-profile-height" name="height" min="1" required class="w-full p-3 rounded-lg" placeholder="Height">
                            </div>
                            <div>
                                <label for="update-profile-gender" class="block text-sm font-medium text-gray-300 mb-2">Gender</label>
                                <select id="update-profile-gender" name="gender" required class="w-full p-3 rounded-lg">
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other/Prefer not to say</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-700/50">
                            <button type="submit" class="flex-grow py-3 mr-2 bg-orange-600 hover:bg-orange-700 rounded-lg font-bold transition shadow-lg shadow-orange-600/50">Update Details</button>
                            <button type="button" id="delete-profile-btn" class="py-3 px-6 ml-2 bg-red-700 hover:bg-red-800 rounded-lg font-bold transition shadow-lg shadow-red-700/50">Delete Profile</button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="mt-8">
                <h3 class="text-xl font-bold mb-4 text-blue-300">Existing Profiles / Quick Log In</h3>
                <div id="profile-list-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <p id="profile-list-status" class="col-span-full text-center text-gray-500 hidden">No profiles found. Create one above!</p>
                </div>
            </div>
        </section>


        <section id="dashboard-view" class="view-section">
            <h2 class="text-2xl font-semibold mb-6 text-purple-300">Today's Overview</h2>
            
            <div id="metric-cards" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="daily-goal-card lg:col-span-1 p-6 rounded-2xl shadow-xl transition transform hover:scale-[1.02]">
                    <h3 class="text-xl font-bold mb-4 text-purple-200">Steps Goal</h3>
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <svg class="w-40 h-40" viewBox="0 0 100 100">
                            <circle class="text-gray-700/50" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/>
                            <circle id="steps-progress" class="progress-ring__circle text-purple-500" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/>
                            <text id="progress-percent" x="50" y="50" class="text-2xl font-bold fill-current text-purple-300" text-anchor="middle" dy=".3em">0%</text>
                        </svg>
                        <p class="text-lg">Goal: <span id="current-goal" class="font-mono text-purple-400">10,000</span> steps</p>
                        <p class="text-lg">Completed: <span id="current-steps" class="font-mono text-purple-400">0</span> steps</p>
                    </div>
                </div>

                <div class="activity-log-card lg:col-span-2 p-6 rounded-2xl shadow-xl">
                    <h3 class="text-xl font-bold mb-4 text-blue-300 flex justify-between items-center">
                        Activity Log
                        <button id="clear-log-btn" class="text-sm text-red-400 hover:text-red-300 transition px-3 py-1 rounded-lg border border-red-400/50 hover:bg-red-900/30">Clear Log</button>
                    </h3>
                    <div class="h-80 overflow-y-auto custom-scrollbar">
                        <table class="min-w-full text-left">
                            <thead class="sticky top-0 bg-gray-900/80 backdrop-blur-sm border-b border-gray-700">
                                <tr>
                                    <th class="p-4 font-medium text-gray-400">Activity</th>
                                    <th class="p-4 font-medium text-gray-400 text-right">Time</th>
                                    <th class="p-4 font-medium text-gray-400 text-right">Distance (km)</th>
                                    <th class="p-4 font-medium text-gray-400 text-right">Calories (kcal)</th>
                                    <th class="p-4 font-medium text-gray-400 text-right">Outcome</th>
                                    <th class="p-4 font-medium text-gray-400 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="activity-list">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="analytics-view" class="view-section">
            <h2 class="text-2xl font-semibold mb-6 text-purple-300">Weekly Analytics</h2>
            
            <div id="analytics-content" class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="bg-gray-800/50 p-6 rounded-2xl shadow-xl border border-yellow-500/30">
                    <h3 class="text-xl font-bold mb-4 text-yellow-300">Weekly Steps Tracker</h3>
                    <canvas id="steps-chart"></canvas>
                </div>

                <div class="bg-gray-800/50 p-6 rounded-2xl shadow-xl border border-green-500/30">
                    <h3 class="text-xl font-bold mb-4 text-green-300">Activity Frequency</h3>
                    <canvas id="activity-chart"></canvas>
                </div>

                <div class="bg-gray-800/50 p-6 rounded-2xl shadow-xl border border-red-500/30 xl:col-span-2">
                    <h3 class="text-xl font-bold mb-4 text-red-300">Weekly Calorie Burn</h3>
                    <canvas id="calories-chart"></canvas>
                </div>
            </div>
             <div id="analytics-login-prompt" class="hidden text-center p-8">
                <p class="text-gray-500">Log in to view your analytics.</p>
            </div>
        </section>

        <section id="log-activity-view" class="view-section">
            <h2 class="text-2xl font-semibold mb-6 text-purple-300">Log New Activity</h2>
            <form id="manual-entry-form" class="max-w-xl mx-auto bg-gray-800/50 p-6 rounded-xl shadow-inner border border-purple-500/30">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="activity-name" class="block text-sm font-medium text-gray-300 mb-1">Select Activity</label>
                        <select id="activity-name" name="name" required class="w-full p-3 rounded-lg"></select>
                    </div>
                    <div>
                        <label for="activity-type" class="block text-sm font-medium text-gray-300 mb-1">Measure By</label>
                        <select id="activity-type" name="type" class="w-full p-3 rounded-lg">
                            <option value="steps">Steps</option>
                            <option value="distance">Distance (km)</option>
                            <option value="time" selected>Time (min)</option>
                        </select>
                    </div>
                </div>

                <div id="step-input" class="mb-4 hidden">
                    <label for="activity-steps" class="block text-sm font-medium text-gray-300 mb-1">Steps Count</label>
                    <input type="number" id="activity-steps" name="steps" min="1" class="w-full p-3 rounded-lg" placeholder="e.g., 5000">
                </div>
                
                <div id="distance-input" class="mb-4 hidden">
                    <label for="activity-distance" class="block text-sm font-medium text-gray-300 mb-1">Distance (km)</label>
                    <input type="number" id="activity-distance" name="distance" step="0.1" min="0.1" class="w-full p-3 rounded-lg" placeholder="e.g., 5.5">
                </div>

                <div id="time-input" class="mb-4">
                    <label for="activity-time" class="block text-sm font-medium text-gray-300 mb-1">Time (minutes)</label>
                    <input type="number" id="activity-time" name="time" min="1" class="w-full p-3 rounded-lg" placeholder="e.g., 30">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Approx. Steps</label>
                        <div id="activity-calculated-steps" data-steps="0" 
                             class="w-full p-3 rounded-lg text-lg font-bold text-center calculated-display">
                            0 steps
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Approx. Time</label>
                        <div id="activity-calculated-time" data-time="0" 
                             class="w-full p-3 rounded-lg text-lg font-bold text-center calculated-display">
                            0 min
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Estimated Calories</label>
                        <div id="activity-calories-display" data-calories="0" 
                             class="w-full p-3 rounded-lg text-lg font-bold text-center calculated-display">
                            0 kcal
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label for="activity-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                    <input type="date" id="activity-date" name="date" required class="w-full p-3 rounded-lg">
                </div>

                <button type="submit" class="w-full py-3 bg-purple-600 hover:bg-purple-700 rounded-lg text-lg font-bold transition shadow-lg shadow-purple-600/50">Log Activity</button>
            </form>
        </section>

        <section id="goals-view" class="view-section">
            <h2 class="text-2xl font-semibold mb-6 text-purple-300">Set and Track Goals</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-800/50 p-6 rounded-xl shadow-inner border border-blue-500/30">
                    <h3 class="text-xl font-bold mb-4 text-blue-300">Daily Steps Goal</h3>
                    <form id="steps-goal-form">
                        <label for="new-steps-goal" class="block text-sm font-medium text-gray-300 mb-2">New Steps Target</label>
                        <div class="flex space-x-3">
                            <input type="number" id="new-steps-goal" name="goal" min="1000" step="500" required class="flex-grow p-3 rounded-lg" placeholder="e.g., 10000">
                            <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold transition shadow-lg shadow-blue-600/50">Set Goal</button>
                        </div>
                    </form>
                    <p class="mt-4 text-gray-400">Current Goal: <span id="current-goal-display" class="font-mono text-blue-400">10,000</span> steps</p>
                </div>
                
                <div class="bg-gray-800/50 p-6 rounded-xl shadow-inner border border-green-500/30">
                    <h3 class="text-xl font-bold mb-4 text-green-300">Goals Overview</h3>
                    <p class="text-gray-400">You can expand this section to track weekly distance or monthly time goals!</p>
                    <div class="h-32 flex items-center justify-center text-green-500 text-6xl opacity-70">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12"><path d="M12 2a10 10 0 1 0 10 10A10.013 10.013 0 0 0 12 2zm3 14h-6a1 1 0 0 1-1-1v-4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1zm-3-8a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Set up Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'purple': {
                            '50': '#f5f3ff', '100': '#ede9fe', '200': '#ddd6fe', '300': '#c4b5fd', '400': '#a78bfa',
                            '500': '#8b5cf6', '600': '#7c3aed', '700': '#6d28d9', '800': '#5b21b6', '900': '#4c1d95',
                        },
                    }
                }
            }
        };

        // --- Global State and Storage Keys ---
        const STORAGE_KEY_PROFILES = 'novaFitProfiles'; 
        const STORAGE_KEY_ALL_DATA = 'novaFitAllData'; 
        const STORAGE_KEY_ACTIVE_ID = 'novaFitActiveProfileId'; 

        // --- Conversion Constants ---
        const KM_TO_STEPS_RATE = 1312.33; // 1 km is approximately 1312 steps (average running/walking)
        const STEPS_TO_KM_RATE = 1 / KM_TO_STEPS_RATE;
        // Average speed in km/minute (km/min)
        const AVG_SPEED_KM_PER_MIN = {
            'Walking': 0.0833, // 5 km/hr (5/60 = 0.0833)
            'Running': 0.1667, // 10 km/hr (10/60 = 0.1667)
            'Cycling': 0.3333, // 20 km/hr (20/60 = 0.3333)
            'Swimming': 0.0167, // 1 km/hr (1/60 = 0.0167)
            'Hiking': 0.05,    // 3 km/hr (3/60 = 0.05)
            // Default for other time-based activities or if speed is irrelevant
            'DEFAULT_TIME': 1 
        };

        // Global application state
        let profiles = [];
        let activeProfileId = null;
        let activeProfileData = { activities: [], dailyGoal: 10000 };
        
        // ADDED: Global chart instances
        let stepsChart, activityChart, caloriesChart;

        // --- Activity Definitions and Calorie Rates (Simplified for Demo) ---
        // Note: Added a 'speed_rate_key' to link to the AVG_SPEED_KM_PER_MIN
        const ACTIVITY_RATES = {
            'Running': { rate_type: 'distance', rate_value: 65, measure_label: 'Distance (km)', speed_rate_key: 'Running' },
            'Walking': { rate_type: 'steps', rate_value: 0.04, measure_label: 'Steps Count', speed_rate_key: 'Walking' },
            'Cycling': { rate_type: 'distance', rate_value: 30, measure_label: 'Distance (km)', speed_rate_key: 'Cycling' },
            'Swimming': { rate_type: 'time', rate_value: 10, measure_label: 'Time (minutes)', speed_rate_key: 'Swimming' },
            'Weight Training': { rate_type: 'time', rate_value: 5, measure_label: 'Time (minutes)', speed_rate_key: 'DEFAULT_TIME' },
            'Yoga': { rate_type: 'time', rate_value: 3, measure_label: 'Time (minutes)', speed_rate_key: 'DEFAULT_TIME' },
            'Hiking': { rate_type: 'distance', rate_value: 50, measure_label: 'Distance (km)', speed_rate_key: 'Hiking' },
        };


        // --- Local Storage Operations ---

        /**
         * Saves all current application state (profiles, data, active ID) to localStorage.
         */
        function saveData() {
            try {
                // 1. Update the master data object with the active profile's data
                const allData = JSON.parse(localStorage.getItem(STORAGE_KEY_ALL_DATA) || '{}');
                if (activeProfileId) {
                    // Only save the activities and dailyGoal from activeProfileData
                    allData[activeProfileId] = {
                        activities: activeProfileData.activities,
                        dailyGoal: activeProfileData.dailyGoal
                    };
                    localStorage.setItem(STORAGE_KEY_ALL_DATA, JSON.stringify(allData));
                }

                // 2. Save the list of profiles and the active ID
                localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles));
                localStorage.setItem(STORAGE_KEY_ACTIVE_ID, activeProfileId || '');

            } catch (e) {
                console.error("Error saving data to localStorage:", e);
                showStatusMessage("Error", "Failed to save data locally.", true);
            }
        }
        
        /**
         * Helper to parse and load the activities/goals data for a specific profile ID 
         * into the activeProfileData global state object.
         */
        function _loadProfileSpecificData(profileId, allData) {
            if (profileId && allData[profileId]) {
                const rawData = allData[profileId];
                activeProfileData.dailyGoal = parseInt(rawData.dailyGoal) || 10000;
                activeProfileData.activities = (rawData.activities || []).map(act => ({
                    ...act,
                    time: parseInt(act.time) || 0,
                    distance: parseFloat(act.distance) || 0,
                    steps: parseInt(act.steps) || 0,
                    calories: parseInt(act.calories) || 0,
                }));
                return true; // Success
            } else {
                // Reset activeProfileData if the profile data is not found
                activeProfileData = { activities: [], dailyGoal: 10000 };
                return false; // Failure
            }
        }


        /**
         * Loads all application data and sets up the active profile.
         */
        function loadData() {
            try {
                // 1. Load profiles list and active ID
                const storedProfiles = localStorage.getItem(STORAGE_KEY_PROFILES);
                // Ensure new profile fields are correctly initialized for older profiles without them
                profiles = storedProfiles ? JSON.parse(storedProfiles).map(p => ({
                    id: p.id,
                    name: p.name,
                    // Parse values and provide defaults if missing (e.g., from older versions)
                    weight: parseFloat(p.weight) || 0, 
                    height: parseInt(p.height) || 0, 
                    gender: p.gender || 'other', 
                })) : [];

                activeProfileId = localStorage.getItem(STORAGE_KEY_ACTIVE_ID);

                // 2. Load all profile data
                const allData = JSON.parse(localStorage.getItem(STORAGE_KEY_ALL_DATA) || '{}');

                // 3. Set active profile data
                const success = _loadProfileSpecificData(activeProfileId, allData);
                
                if (!success) {
                    // Reset to default if active profile is missing or invalid
                    activeProfileId = null;
                    activeProfileData = { activities: [], dailyGoal: 10000 };
                }

            } catch (e) {
                console.error("Error loading data from localStorage. Resetting to defaults.", e);
                // Explicitly clear all state on failure to guarantee a clean slate for initApp
                profiles = [];
                activeProfileId = null;
                activeProfileData = { activities: [], dailyGoal: 10000 };
                throw new Error("Failed to load data due to corruption. State reset."); // Propagate error for initApp to catch
            }
        }
        
        // --- Profile Management Logic ---

        /**
         * Creates a new profile and switches to it.
         */
        function createProfile(formData) { 
             // Save the currently active profile data before switching/creating
             if (activeProfileId) {
                 saveData(); 
             }
            
            // Simple unique ID generation
            const newId = Date.now().toString(); 
            const newProfile = { 
                id: newId, 
                name: formData.name, 
                weight: parseFloat(formData.weight) || 0, 
                height: parseInt(formData.height) || 0, 
                gender: formData.gender || 'other', 
            };

            profiles.push(newProfile);
            activeProfileId = newId;
            activeProfileData = { activities: [], dailyGoal: 10000 };
            
            saveData();
            renderApp();
            showStatusMessage("Success", `Profile '${formData.name}' created and logged in!`);
            handleNavigation('dashboard-view');
        }
        
        /**
         * Updates the personal details of the currently active profile.
         */
        function updateProfileDetails(formData) {
            const activeProfileIndex = profiles.findIndex(p => p.id === activeProfileId);
            
            if (activeProfileIndex === -1) {
                showStatusMessage("Error", "Active profile not found.", true);
                return;
            }
            
            const profile = profiles[activeProfileIndex];
            
            profile.name = formData.name.trim();
            profile.weight = parseFloat(formData.weight) || 0;
            profile.height = parseInt(formData.height) || 0;
            profile.gender = formData.gender || 'other';

            saveData();
            renderApp();
            showStatusMessage("Success", `Profile details for '${profile.name}' updated.`);
        }


        /**
         * Switches the active profile (logs in) and reloads/renders all app data.
         */
        function switchProfile(id) {
            if (activeProfileId !== id) {
                // Save the currently active profile data before changing the ID
                if (activeProfileId) {
                    saveData();
                }

                activeProfileId = id; // Set the intended new ID
                
                // 1. Load all profile data from storage
                // Use a try-catch for the initial load just in case the overall data store is corrupted
                let allData = {};
                try {
                    allData = JSON.parse(localStorage.getItem(STORAGE_KEY_ALL_DATA) || '{}');
                } catch (e) {
                    console.error("Error loading master data during profile switch:", e);
                    showStatusMessage("Warning", "Data corruption detected during switch. Some history may be missing.", true);
                    allData = {}; // Ensure it is still an empty object to proceed
                }
                
                // 2. Load the specific data for the newly set activeProfileId
                _loadProfileSpecificData(activeProfileId, allData);
                
                // 3. Save the new active ID
                localStorage.setItem(STORAGE_KEY_ACTIVE_ID, activeProfileId);
                renderApp();
                const profileName = profiles.find(p => p.id === activeProfileId)?.name || 'Unknown User';
                showStatusMessage("Logged In", `Switched to profile: ${profileName}`);
                handleNavigation('dashboard-view');
            } else {
                const profileName = profiles.find(p => p.id === activeProfileId)?.name || 'Unknown User';
                showStatusMessage("Info", `You are already logged in as: ${profileName}`);
            }
        }

        /**
         * Deletes a profile by its ID. (Uses native window.confirm)
         */
        function deleteProfile(id) {
            const profileToDelete = profiles.find(p => p.id === id);
            if (!profileToDelete) {
                showStatusMessage("Error", "Profile not found.", true);
                return;
            }

            // 1. Confirmation (Use standard browser confirm)
            if (!window.confirm(`Are you sure you want to delete profile: ${profileToDelete.name}? This will remove ALL associated activity data permanently.`)) {
                showStatusMessage("Cancelled", "Profile deletion cancelled.");
                return;
            }

            // 2. Remove from profiles list
            profiles = profiles.filter(p => p.id !== id);

            // 3. Remove data from localStorage (master data object)
            const allData = JSON.parse(localStorage.getItem(STORAGE_KEY_ALL_DATA) || '{}');
            delete allData[id];
            localStorage.setItem(STORAGE_KEY_ALL_DATA, JSON.stringify(allData));

            // 4. If active, reset active profile and clear global data state
            if (activeProfileId === id) {
                activeProfileId = null;
                activeProfileData = { activities: [], dailyGoal: 10000 };
            }

            // 5. Save the updated profiles list and null active ID
            saveData();
            renderApp();
            showStatusMessage("Success", `Profile '${profileToDelete.name}' has been permanently deleted.`);
            handleNavigation('profile-view');
        }


        // --- Utility Functions ---

        /**
         * Shows a temporary status message to the user.
         */
        function showStatusMessage(title, message, isError = false) {
            const statusEl = document.getElementById('status-message');
            const color = isError ? 'bg-red-600 shadow-red-500/50' : 'bg-green-600 shadow-green-500/50';
            statusEl.innerHTML = `
                <div class="px-6 py-3 rounded-xl text-white font-semibold ${color} shadow-lg transition-all duration-300">
                    <strong>${title}:</strong> ${message}
                </div>
            `;
            statusEl.classList.remove('opacity-0');
            statusEl.classList.add('opacity-100');

            setTimeout(() => {
                statusEl.classList.remove('opacity-100');
                statusEl.classList.add('opacity-0');
            }, 3000);
        }

        /**
         * Handles navigation between different views.
         */
        function handleNavigation(targetViewId) {
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
                if (section.id === targetViewId) {
                    section.classList.add('active');
                }
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.view === targetViewId) {
                    link.classList.add('active');
                }
            });

            // Disable nav links if no user is logged in, except the Profile link
            if (!activeProfileId) {
                document.querySelectorAll('.nav-link:not(#nav-profile)').forEach(link => {
                    link.disabled = true;
                    link.classList.add('opacity-50', 'cursor-not-allowed');
                });
                // Force navigation to profile view if a restricted view is selected without a profile
                if (targetViewId !== 'profile-view') {
                    // This prevents the empty dashboard/analytics view from showing when not logged in
                    handleNavigation('profile-view');
                }
            } else {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.disabled = false;
                    link.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            }
        }

        /**
         * Formats time from minutes into Hh Mm string.
         */
        function formatTime(mins) {
            if (mins < 1) return '<1 min'; // Handle very small numbers
            if (mins < 60) return `${Math.round(mins)} min`;
            return `${Math.floor(mins / 60)}h ${Math.round(mins % 60)}m`;
        }


        // --- Core Calculation Logic ---

        /**
         * Calculates steps based on distance (km).
         */
        function calculateSteps(distanceKm) {
            if (distanceKm <= 0) {
                return 0;
            }
            // Use the global conversion rate and round to nearest whole step
            return Math.round(distanceKm * KM_TO_STEPS_RATE);
        }

        /**
         * Calculates approximate time (in minutes) based on distance (km) and activity speed.
         */
        function calculateTime(activityName, distanceKm) {
            if (distanceKm <= 0) {
                return 0;
            }

            const activityData = ACTIVITY_RATES[activityName];
            const speedRateKey = activityData ? activityData.speed_rate_key : 'DEFAULT_TIME';
            const kmPerMin = AVG_SPEED_KM_PER_MIN[speedRateKey];

            if (!kmPerMin || kmPerMin <= 0) {
                return 0; // Avoid division by zero
            }

            // Time (min) = Distance (km) / Speed (km/min)
            return Math.round(distanceKm / kmPerMin);
        }


        /**
         * Calculates calories based on activity type, rate, and measured value.
         */
        function calculateCalories(activityName, value) {
            const activityData = ACTIVITY_RATES[activityName];
            if (!activityData || value <= 0) {
                return 0;
            }
            // Calorie rate is per value unit (e.g., per step, per minute, per km)
            const rate = activityData.rate_value; 
            return Math.floor(rate * value);
        }

        /**
         * Calculates metrics for the dashboard from the current active profile's activities.
         */
        function calculateMetrics() {
            // Get today's date in YYYY-MM-DD format for filtering
            const today = new Date().toISOString().split('T')[0];
            const activities = activeProfileData.activities;
            const dailyGoal = activeProfileData.dailyGoal;

            const total = activities.reduce((acc, act) => {
                const dateMatch = act.date === today;
                
                acc.totalTime += act.time;
                acc.totalDistance += act.distance;
                acc.totalSteps += act.steps;
                acc.totalCalories += act.calories;

                if (dateMatch) {
                    acc.todaySteps += act.steps;
                }
                
                return acc;
            }, {
                totalSteps: 0,
                totalDistance: 0,
                totalTime: 0,
                totalCalories: 0,
                todaySteps: 0
            });

            return {
                ...total,
                totalActivities: activities.length,
                stepsGoalProgress: Math.min(100, (total.todaySteps / dailyGoal) * 100)
            };
        }


        // --- UI Rendering Functions ---

        /**
         * Renders the Profile View content (profile list, status, and active user details).
         */
        function renderProfileView() {
            const listContainer = document.getElementById('profile-list-container');
            const listStatus = document.getElementById('profile-list-status');
            const detailsDiv = document.getElementById('active-profile-details');
            const currentInfoEl = document.getElementById('current-profile-info');
            const activityCountEl = document.getElementById('current-profile-activity-count');

            // elements for update form
            const updateFieldsDiv = document.getElementById('update-profile-fields');
            const updateStatusP = document.getElementById('update-profile-status');
            
            // Check for required elements
            if (!listContainer || !listStatus || !detailsDiv || !currentInfoEl || !activityCountEl || !updateFieldsDiv || !updateStatusP) {
                console.error("renderProfileView: Missing one or more required DOM elements. Aborting render.");
                return;
            }

            listContainer.innerHTML = '';

            // --- Render Profile Buttons ---
            if (profiles.length === 0) {
                listStatus.classList.remove('hidden');
            } else {
                listStatus.classList.add('hidden');
                profiles.forEach(p => {
                    const isActive = p.id === activeProfileId;
                    const button = document.createElement('button');
                    button.className = `p-4 rounded-xl font-semibold transition text-left w-full shadow-lg border-2 ${
                        isActive 
                        ? 'bg-purple-600/50 border-purple-400 ring-2 ring-purple-400' 
                        : 'bg-blue-800/30 border-blue-500/20 hover:bg-blue-600/50'
                    }`;
                    button.textContent = p.name;
                    button.onclick = () => switchProfile(p.id);
                    listContainer.appendChild(button);
                });
            }

            // --- Render Active Profile Details & Update Form ---
            if (activeProfileId) {
                const activeProfile = profiles.find(p => p.id === activeProfileId);
                const metrics = calculateMetrics(); // Get total activities for the active profile

                if (activeProfile) {
                    // Update Profile Details Card
                    currentInfoEl.innerHTML = `
                        <p class="font-bold text-xl">${activeProfile.name}</p>
                        <p>Weight: <span class="text-cyan-400">${activeProfile.weight} kg</span></p>
                        <p>Height: <span class="text-cyan-400">${activeProfile.height} cm</span></p>
                        <p>Gender: <span class="text-cyan-400">${activeProfile.gender.charAt(0).toUpperCase() + activeProfile.gender.slice(1)}</span></p>
                    `;
                    activityCountEl.textContent = metrics.totalActivities;

                    // Populate Update Form
                    document.getElementById('update-profile-name').value = activeProfile.name;
                    document.getElementById('update-profile-weight').value = activeProfile.weight;
                    document.getElementById('update-profile-height').value = activeProfile.height;
                    document.getElementById('update-profile-gender').value = activeProfile.gender;
                    
                    updateStatusP.classList.add('hidden');
                    updateFieldsDiv.classList.remove('hidden');
                    detailsDiv.classList.remove('border-green-500/30');
                    detailsDiv.classList.add('border-purple-500/30');
                    
                } else {
                    // Case: activeProfileId exists but the profile is missing (data corruption)
                    currentInfoEl.innerHTML = `<p class="text-red-400">Error: Profile data is corrupted. Please select a profile below or create a new one.</p>`;
                    activityCountEl.textContent = 'ERROR';
                    updateStatusP.classList.remove('hidden');
                    updateStatusP.textContent = "Error: Active profile not found in list.";
                    updateFieldsDiv.classList.add('hidden');
                    detailsDiv.classList.add('border-green-500/30');
                    detailsDiv.classList.remove('border-purple-500/30');
                }
                
                document.getElementById('active-profile-display').textContent = `(${activeProfile?.name || 'Error'})`;

            } else {
                // Not logged in
                currentInfoEl.innerHTML = '<p>Please create or select a profile to begin tracking.</p>';
                activityCountEl.textContent = '0';
                updateStatusP.classList.remove('hidden');
                updateStatusP.textContent = "Please log in to update your profile.";
                updateFieldsDiv.classList.add('hidden');
                document.getElementById('active-profile-display').textContent = '';
                detailsDiv.classList.add('border-green-500/30');
                detailsDiv.classList.remove('border-purple-500/30');
            }
        }


        /**
         * Renders the main dashboard view metrics and activity log.
         */
        function renderDashboard(metrics) {
            const today = new Date().toISOString().split('T')[0];
            const activitiesToday = activeProfileData.activities.filter(a => a.date === today);

            // --- 1. Metric Cards ---
            const cardData = [
                { title: "Today's Steps", value: metrics.todaySteps.toLocaleString(), unit: 'steps', color: 'purple' },
                { title: "Total Activities", value: metrics.totalActivities, unit: 'sessions', color: 'blue' },
                { title: "Total Distance", value: metrics.totalDistance.toFixed(1), unit: 'km', color: 'cyan' },
                { title: "Total Calories", value: metrics.totalCalories.toLocaleString(), unit: 'kcal', color: 'red' },
                { title: "Total Time", value: formatTime(metrics.totalTime), unit: '', color: 'green' },
            ];
            
            const metricsContainer = document.getElementById('metric-cards');
            metricsContainer.innerHTML = cardData.map(card => `
                <div class="bg-gray-800/50 p-4 rounded-xl shadow-inner border border-${card.color}-500/30">
                    <p class="text-sm font-medium text-gray-400">${card.title}</p>
                    <p class="text-2xl font-bold text-${card.color}-300 mt-1">
                        ${card.value} <span class="text-base font-normal">${card.unit}</span>
                    </p>
                </div>
            `).join('');

            // --- 2. Steps Goal Progress Ring ---
            const progressCircle = document.getElementById('steps-progress');
            const progressPercentEl = document.getElementById('progress-percent');
            const goalEl = document.getElementById('current-goal');
            const stepsEl = document.getElementById('current-steps');

            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (metrics.stepsGoalProgress / 100) * circumference;

            progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            progressCircle.style.strokeDashoffset = offset;
            progressPercentEl.textContent = `${Math.floor(metrics.stepsGoalProgress)}%`;
            
            goalEl.textContent = activeProfileData.dailyGoal.toLocaleString();
            stepsEl.textContent = metrics.todaySteps.toLocaleString();


            // --- 3. Activity List ---
            const activityListEl = document.getElementById('activity-list');
            activityListEl.innerHTML = '';
            
            if (activitiesToday.length === 0) {
                activityListEl.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">No activities logged today. Go log one!</td></tr>`;
            } else {
                activitiesToday.slice().reverse().forEach((activity, index) => {
                    const row = document.createElement('tr');
                    const originalIndex = activeProfileData.activities.findIndex(a => a.id === activity.id); // Find the index in the original array
                    
                    row.className = 'border-b border-gray-800 hover:bg-gray-800/50 transition';
                    row.innerHTML = `
                        <td class="p-4 font-semibold text-purple-200">${activity.name}</td>
                        <td class="p-4 text-right text-gray-300">${formatTime(activity.time)}</td>
                        <td class="p-4 text-right text-gray-300">${activity.distance.toFixed(2)} km</td>
                        <td class="p-4 text-right text-red-300">${activity.calories} kcal</td>
                        <td class="p-4 text-right text-yellow-300">${activity.steps.toLocaleString()} steps</td>
                        <td class="p-4 text-center">
                            <button data-index="${originalIndex}" class="delete-activity-btn text-red-500 hover:text-red-400 transition" title="Delete Activity">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </td>
                    `;
                    activityListEl.appendChild(row);
                });
            }
        }

        /**
         * Renders the Analytics charts.
         */
        function renderAnalytics(metrics) {
            // Check if user is logged in (handled in renderApp but good practice to check here too)
            if (!activeProfileId) return;

            // Group activities by date for the last 7 days
            const today = new Date();
            const pastSevenDays = Array(7).fill(0).map((_, i) => {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                return d.toISOString().split('T')[0]; // YYYY-MM-DD
            }).reverse(); // Reverse to get chronological order

            const dailyData = activeProfileData.activities.reduce((acc, act) => {
                const date = act.date;
                if (pastSevenDays.includes(date)) {
                    acc[date] = acc[date] || { steps: 0, calories: 0, count: 0 };
                    acc[date].steps += act.steps;
                    acc[date].calories += act.calories;
                    acc[date].count += 1;
                }
                return acc;
            }, {});

            // Prepare chart data arrays
            const stepsData = pastSevenDays.map(date => dailyData[date]?.steps || 0);
            const caloriesData = pastSevenDays.map(date => dailyData[date]?.calories || 0);
            const activityCountData = pastSevenDays.map(date => dailyData[date]?.count || 0);
            
            const labels = pastSevenDays.map(date => {
                const [year, month, day] = date.split('-');
                return `${month}/${day}`; // MM/DD
            });

            // --- Chart 1: Steps Tracker ---
            const stepsCtx = document.getElementById('steps-chart').getContext('2d');
            if (stepsChart) stepsChart.destroy();
            stepsChart = new Chart(stepsCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Steps',
                        data: stepsData,
                        backgroundColor: 'rgba(251, 191, 36, 0.2)', // yellow-400
                        borderColor: '#facc15', // yellow-400
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#e5e7eb' } },
                        x: { grid: { display: false }, ticks: { color: '#e5e7eb' } }
                    },
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#334155', titleColor: '#fff', bodyColor: '#fff' } }
                }
            });

            // --- Chart 2: Activity Frequency ---
            const activityCtx = document.getElementById('activity-chart').getContext('2d');
            if (activityChart) activityChart.destroy();
            activityChart = new Chart(activityCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Activities Logged',
                        data: activityCountData,
                        backgroundColor: '#4ade80', // green-400
                        borderColor: '#22c55e',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0, color: '#e5e7eb' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { grid: { display: false }, ticks: { color: '#e5e7eb' } }
                    },
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#334155', titleColor: '#fff', bodyColor: '#fff' } }
                }
            });

            // --- Chart 3: Calorie Burn ---
            const caloriesCtx = document.getElementById('calories-chart').getContext('2d');
            if (caloriesChart) caloriesChart.destroy();
            caloriesChart = new Chart(caloriesCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calories Burned (kcal)',
                        data: caloriesData,
                        backgroundColor: '#f87171', // red-400
                        borderColor: '#ef4444',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#e5e7eb' } },
                        x: { grid: { display: false }, ticks: { color: '#e5e7eb' } }
                    },
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: '#334155', titleColor: '#fff', bodyColor: '#fff' } }
                }
            });
        }
        
        /**
         * The main rendering function, called after data is loaded or changed.
         */
        function renderApp() {
            renderProfileView(); 
            
            // Only render dashboard and analytics if a user is logged in
            if (activeProfileId) {
                const metrics = calculateMetrics();
                
                // Dashboard
                renderDashboard(metrics);
                document.getElementById('current-goal-display').textContent = activeProfileData.dailyGoal.toLocaleString();

                // Analytics
                renderAnalytics(metrics);
                
                // Show analytics content
                document.getElementById('analytics-content').classList.remove('hidden');
                document.getElementById('analytics-login-prompt').classList.add('hidden');
                
            } else {
                // Hide analytics content and show login prompt
                document.getElementById('analytics-content').classList.add('hidden');
                document.getElementById('analytics-login-prompt').classList.remove('hidden');
            }
            
            // Re-enable/disable nav links and set initial view
            handleNavigation(document.querySelector('.nav-link.active')?.dataset.view || 'dashboard-view');
        }


        // --- Event Listener Setup ---

        /**
         * Sets up form submissions for profile creation and updates.
         */
        function setupProfileForms() {
            document.getElementById('create-profile-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = Object.fromEntries(new FormData(e.target).entries());
                createProfile(formData);
                e.target.reset(); // Clear form on success
            });
            
            document.getElementById('update-profile-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = Object.fromEntries(new FormData(e.target).entries());
                updateProfileDetails(formData);
            });
            
            document.getElementById('delete-profile-btn').addEventListener('click', () => {
                if (activeProfileId) {
                    deleteProfile(activeProfileId);
                } else {
                    showStatusMessage("Error", "No active profile to delete.", true);
                }
            });
        }
        
        /**
         * Sets up navigation links.
         */
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    handleNavigation(e.target.dataset.view);
                });
            });
        }
        
        /**
         * Sets up the activity logging form and associated calculations.
         */
        function setupManualEntry() {
            const form = document.getElementById('manual-entry-form');
            const activityTypeSelect = document.getElementById('activity-type');
            const activityNameSelect = document.getElementById('activity-name');
            const stepInputDiv = document.getElementById('step-input');
            const distanceInputDiv = document.getElementById('distance-input');
            const timeInputDiv = document.getElementById('time-input');
            const dateInput = document.getElementById('activity-date');

            // Set today's date as default
            dateInput.value = new Date().toISOString().split('T')[0];

            // Populate Activity Name Select
            Object.keys(ACTIVITY_RATES).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                activityNameSelect.appendChild(option);
            });
            
            // Set default activity (Running or Walking if available)
            activityNameSelect.value = ACTIVITY_RATES.Running ? 'Running' : Object.keys(ACTIVITY_RATES)[0];


            // Helper function to update input visibility based on measurement type
            function updateInputVisibility() {
                const type = activityTypeSelect.value;
                stepInputDiv.classList.toggle('hidden', type !== 'steps');
                distanceInputDiv.classList.toggle('hidden', type !== 'distance');
                timeInputDiv.classList.toggle('hidden', type !== 'time');

                // Reset inputs when switching type
                document.getElementById('activity-steps').value = '';
                document.getElementById('activity-distance').value = '';
                document.getElementById('activity-time').value = '';
                
                updateCalculations();
            }

            // Helper function to calculate and update the derived fields
            function updateCalculations() {
                const type = activityTypeSelect.value;
                const activityName = activityNameSelect.value;
                let primaryValue = 0;
                let time = 0;
                let steps = 0;
                let distanceKm = 0;

                // 1. Determine primary value and calculate the others
                if (type === 'steps') {
                    primaryValue = parseInt(document.getElementById('activity-steps').value) || 0;
                    distanceKm = primaryValue * STEPS_TO_KM_RATE;
                    steps = primaryValue;
                    time = calculateTime(activityName, distanceKm); // Calculate time from distance
                } else if (type === 'distance') {
                    primaryValue = parseFloat(document.getElementById('activity-distance').value) || 0;
                    distanceKm = primaryValue;
                    steps = calculateSteps(distanceKm); // Calculate steps from distance
                    time = calculateTime(activityName, distanceKm); // Calculate time from distance
                } else if (type === 'time') {
                    primaryValue = parseInt(document.getElementById('activity-time').value) || 0;
                    time = primaryValue;
                    
                    // Estimate distance from time using average speed
                    const activityData = ACTIVITY_RATES[activityName];
                    const speedRateKey = activityData ? activityData.speed_rate_key : 'DEFAULT_TIME';
                    const kmPerMin = AVG_SPEED_KM_PER_MIN[speedRateKey];
                    distanceKm = primaryValue * kmPerMin; 
                    
                    steps = calculateSteps(distanceKm); // Calculate steps from distance
                }

                // 2. Calculate calories
                // We calculate calories based on the activity's preferred measurement type/value
                const rateType = ACTIVITY_RATES[activityName].rate_type;
                let caloriesValue = 0;
                if (rateType === 'steps') {
                    caloriesValue = calculateCalories(activityName, steps);
                } else if (rateType === 'distance') {
                    caloriesValue = calculateCalories(activityName, distanceKm);
                } else if (rateType === 'time') {
                    caloriesValue = calculateCalories(activityName, time);
                }
                
                // 3. Update display fields
                document.getElementById('activity-calculated-steps').textContent = `${steps.toLocaleString()} steps`;
                document.getElementById('activity-calculated-steps').dataset.steps = steps;
                
                document.getElementById('activity-calculated-time').textContent = formatTime(time);
                document.getElementById('activity-calculated-time').dataset.time = time;
                
                document.getElementById('activity-calories-display').textContent = `${caloriesValue.toLocaleString()} kcal`;
                document.getElementById('activity-calories-display').dataset.calories = caloriesValue;
            }

            // Event listeners for changes
            activityTypeSelect.addEventListener('change', updateInputVisibility);
            activityNameSelect.addEventListener('change', updateCalculations);
            document.getElementById('activity-steps').addEventListener('input', updateCalculations);
            document.getElementById('activity-distance').addEventListener('input', updateCalculations);
            document.getElementById('activity-time').addEventListener('input', updateCalculations);
            
            // Initial setup
            updateInputVisibility();


            // Handle form submission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (!activeProfileId) {
                    showStatusMessage("Error", "Please log in to log an activity.", true);
                    return;
                }

                const calculatedSteps = parseInt(document.getElementById('activity-calculated-steps').dataset.steps);
                const calculatedTime = parseInt(document.getElementById('activity-calculated-time').dataset.time);
                const calculatedCalories = parseInt(document.getElementById('activity-calories-display').dataset.calories);

                // Use the calculated distance/time/steps from updateCalculations()
                const activityDistance = parseFloat(document.getElementById('activity-distance').value) || 0;
                
                const newActivity = {
                    id: Date.now().toString(),
                    name: activityNameSelect.value,
                    date: dateInput.value,
                    time: calculatedTime, 
                    distance: calculatedDistance(activityNameSelect.value, calculatedTime),
                    steps: calculatedSteps,
                    calories: calculatedCalories,
                    loggedAt: new Date().toISOString()
                };
                
                // If a manual distance was entered, use it for saving the activity
                if (activityTypeSelect.value === 'distance' && activityDistance > 0) {
                     newActivity.distance = activityDistance;
                }
                // If a manual step count was entered, use it for saving the activity
                else if (activityTypeSelect.value === 'steps' && parseInt(document.getElementById('activity-steps').value) > 0) {
                    // Recalculate everything else based on the entered steps
                    newActivity.steps = parseInt(document.getElementById('activity-steps').value);
                    newActivity.distance = newActivity.steps * STEPS_TO_KM_RATE;
                    newActivity.time = calculateTime(newActivity.name, newActivity.distance);
                    newActivity.calories = calculateCalories(newActivity.name, newActivity.steps); // Assuming steps is the primary rate for walking/running
                }
                // If a manual time was entered, use it for saving the activity
                else if (activityTypeSelect.value === 'time' && calculatedTime > 0) {
                     // The calculated values are based on the entered time, so we are good.
                } else {
                     showStatusMessage("Error", "Please enter a valid value (Steps, Distance, or Time).", true);
                     return;
                }

                activeProfileData.activities.push(newActivity);
                saveData();
                renderApp();
                showStatusMessage("Success", `Activity '${newActivity.name}' logged!`);
                form.reset();
                updateInputVisibility(); // Reset form visibility and calculations
                dateInput.value = new Date().toISOString().split('T')[0]; // Reset date to today
            });
            
            // Re-define helper function for submission logic to use Time input consistently
            function calculatedDistance(activityName, timeInMinutes) {
                const activityData = ACTIVITY_RATES[activityName];
                const speedRateKey = activityData ? activityData.speed_rate_key : 'DEFAULT_TIME';
                const kmPerMin = AVG_SPEED_KM_PER_MIN[speedRateKey];
                return parseFloat((timeInMinutes * kmPerMin).toFixed(2));
            }
        }
        
        /**
         * Sets up the goal setting form.
         */
        function setupGoalForm() {
            document.getElementById('steps-goal-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (!activeProfileId) {
                    showStatusMessage("Error", "Please log in to set a goal.", true);
                    return;
                }
                
                const newGoal = parseInt(document.getElementById('new-steps-goal').value);
                if (newGoal > 0) {
                    activeProfileData.dailyGoal = newGoal;
                    saveData();
                    renderApp();
                    showStatusMessage("Success", `Daily steps goal set to ${newGoal.toLocaleString()}!`);
                } else {
                    showStatusMessage("Error", "Please enter a valid goal.", true);
                }
            });
        }
        
        /**
         * Sets up the activity log clear button.
         */
        function setupClearLog() {
             document.getElementById('clear-log-btn').addEventListener('click', () => {
                if (!activeProfileId) {
                    showStatusMessage("Error", "No active profile log to clear.", true);
                    return;
                }
                
                if (window.confirm("Are you sure you want to clear ALL activity logs for the current profile? This cannot be undone.")) {
                    activeProfileData.activities = [];
                    saveData();
                    renderApp();
                    showStatusMessage("Success", "All activities have been cleared.");
                } else {
                    showStatusMessage("Cancelled", "Activity log clear cancelled.");
                }
            });
            
             // Delegation for individual activity deletion
            document.getElementById('activity-list').addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-activity-btn');
                if (deleteButton) {
                    const index = parseInt(deleteButton.dataset.index);
                    if (index >= 0 && index < activeProfileData.activities.length) {
                        if (window.confirm("Are you sure you want to delete this activity?")) {
                            activeProfileData.activities.splice(index, 1);
                            saveData();
                            renderApp();
                            showStatusMessage("Deleted", "Activity removed from log.");
                        }
                    }
                }
            });
        }
        
        // --- Particle System Logic ---

        function generateParticles() {
            const container = document.getElementById('particles-container');
            const count = 50; // Number of particles
            const duration = 20; // Animation duration in seconds (for flow and fade)

            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';

                // Random size (2px to 8px)
                const size = Math.random() * 6 + 2; 
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;

                // Random start position
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.top = `${Math.random() * 100}vh`;

                // Random animation duration and delay (staggering the animation)
                particle.style.animationDuration = `${duration + Math.random() * 10}s`;
                particle.style.animationDelay = `-${Math.random() * duration}s, -${Math.random() * duration}s`;

                // Random flow offsets (for the CSS variable in the flow keyframe)
                const flowX = Math.random() * 200 - 100; 
                const flowY = Math.random() * 200 - 100; 
                particle.style.setProperty('--flow-x', `${flowX}px`);
                particle.style.setProperty('--flow-y', `${flowY}px`);

                container.appendChild(particle);
            }
        }


        // --- Application Initialization ---

        /**
         * The main initialization function for the app.
         * CRITICAL FIX: Added a global try/catch block to ensure the app loads even if data is corrupted.
         */
        function initApp() {
            try {
                loadData(); // Load all data from localStorage first
                setupProfileForms();
                setupNavigation();
                setupManualEntry();
                setupGoalForm();
                setupClearLog();
                generateParticles();
                
                // Apply initial dark mode styling to static cards
                document.querySelector('.daily-goal-card').classList.add('bg-white/10', 'backdrop-blur-md', 'border-purple-500/30', 'border');
                document.querySelector('.activity-log-card').classList.add('bg-white/10', 'backdrop-blur-md', 'border-blue-500/30', 'border');
                
            } catch (e) {
                console.error("CRITICAL APP INITIALIZATION ERROR. Resetting state and forcing render.", e);
                // Force state reset in case loadData didn't catch the error
                profiles = [];
                activeProfileId = null;
                activeProfileData = { activities: [], dailyGoal: 10000 };
                // Notify user that their data was corrupted and reset.
                showStatusMessage("CRITICAL ERROR", "Corrupted data detected. Application state was reset. Please create a new profile.", true);
            }
            
            renderApp(); // Always attempt to render the UI with the latest (possibly reset) data
        }

        // Initialize the application when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
