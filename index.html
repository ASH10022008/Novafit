<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaFit Tracker - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { projectId: 'mock-project' };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false; // Flag to track readiness

        // Ensure global data structure is defined before any save/load operation
        window.data = window.data || {
            profile: { name: 'User', gender: 'male', weight: 70, height: 175 },
            goal: { calories: 2000, protein: 150, carbs: 200, fat: 50 },
            log: []
        };
        window.appId = appId;


        // --- Firestore Utility Functions (Must be in module scope) ---

        /**
         * Gets the Firestore document reference for the user's data.
         * @param {object} db The Firestore instance.
         * @param {string} userId The current user's ID.
         * @returns {object} Firestore DocumentReference
         */
        function getUserDocRef(db, userId) {
            if (!userId || !db) return null;
            // Private data path: /artifacts/{appId}/users/{userId}/nova_fit_data/user_data
            const docPath = `/artifacts/${appId}/users/${userId}/nova_fit_data`;
            return doc(db, docPath, 'user_data');
        }

        /**
         * Saves the current data object to Firestore.
         */
        async function saveDataToFirestore() {
            if (!isAuthReady || !userId || !db) {
                console.error("Authentication not ready or user ID is missing. Cannot save data.");
                window.messageToast("Authentication not ready. Cannot save data.", 'error');
                return;
            }
            try {
                const docRef = getUserDocRef(db, userId);
                // Deep clone and ensure log is serializable
                const dataToSave = JSON.parse(JSON.stringify(window.data)); 
                await setDoc(docRef, dataToSave);
                console.log("Data saved to Firestore.");
                window.messageToast("Data saved successfully!", 'success');
            } catch (error) {
                console.error("Error saving document:", error);
                window.messageToast("Error saving data. See console.", 'error');
            }
        }
        
        /**
         * Sets up the real-time listener for user data from Firestore.
         */
        function setupFirestoreListener() {
            if (!userId || !db) return;

            const docRef = getUserDocRef(db, userId);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Document data received from Firestore.");
                    const newData = docSnap.data();
                    
                    // Update global data object, using defaults if fields are missing
                    window.data = {
                        profile: newData.profile || window.data.profile,
                        goal: newData.goal || window.data.goal,
                        log: Array.isArray(newData.log) ? newData.log : []
                    };
                    
                    // Re-render the application UI
                    if (typeof window.renderApp === 'function') {
                        window.renderApp();
                    }
                } else {
                    console.log("No initial document found, creating default data.");
                    // Create default data on first load
                    saveDataToFirestore(); 
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                window.messageToast("Failed to listen for data changes.", 'error');
            });
        }
        
        // --- End Firestore Utility Functions ---


        // Initialize Firebase and Authentication
        async function initializeFirebase() {
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set persistence to local storage to maintain session
                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Update the global references used by the non-module script
                        window.userId = user.uid; 
                        console.log("Firebase Auth State Changed. User ID:", userId);
                    } else {
                        // User is signed out or first time load
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            // The onAuthStateChanged listener will fire again with the new user
                        } catch (error) {
                            console.error("Error during initial sign-in:", error);
                        }
                    }
                    
                    // Once auth state is determined, we are ready to load data
                    isAuthReady = true;
                    if (userId) {
                        setupFirestoreListener(); // Start listening for data
                        document.getElementById('user-id-display').textContent = userId;
                        
                        // FIX: Enable UI listeners only when authentication is complete
                        if (typeof window.setupAppListeners === 'function') {
                            window.setupAppListeners();
                        }

                    } else {
                        // If anonymous sign-in failed, show an error and use default data
                        window.renderApp();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                if (typeof window.messageToast === 'function') {
                    window.messageToast("Error initializing Firebase. See console.", 'error');
                }
            }
        }
        
        // Expose necessary functions/variables globally for non-module script access
        window.initializeFirebase = initializeFirebase;
        window.saveDataToFirestore = saveDataToFirestore;

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            transition: background-color 0.5s, color 0.5s; /* Smooth transition for theme change */
            color: #e5e5e5; /* Default text color for dark mode */
        }
        /* --- Dark Mode Styles (Default) --- */
        .neon-gradient {
            background: linear-gradient(135deg, #0f172a, #7e22ce, #06b6d4);
            background-size: 600% 600%;
            animation: gradientShift 16s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- Particle System Styles --- */
        #particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            pointer-events: none;
        }
        .particle {
            position: absolute;
            background: rgba(126, 34, 206, 0.5); /* Purple/Blue glow */
            border-radius: 50%;
            animation: move linear infinite, flow var(--duration) linear infinite;
            filter: blur(2px);
            opacity: 0;
        }

        @keyframes move {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { transform: translateY(-10vh) scale(1); opacity: 0; }
        }

        /* Flow animation adds subtle horizontal/vertical drift */
        @keyframes flow {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(var(--flow-x, 0px), var(--flow-y, 0px)); }
        }

        /* Custom style for the circular progress bar */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Message Toast Styles */
        #message-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            z-index: 1000;
        }
        .toast-success { background-color: #10b981; color: white; }
        .toast-error { background-color: #ef4444; color: white; }
        
        /* Loading overlay for entry card */
        #manual-entry-form-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9); /* slate-900 with opacity */
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.3s;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #7e22ce;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="neon-gradient min-h-screen text-white p-4 sm:p-8">

    <!-- Background Particle System Container -->
    <div id="particles-container"></div>

    <!-- Message Toast Element -->
    <div id="message-toast" class="font-semibold"></div>
    
    <div class="max-w-7xl mx-auto">
        
        <!-- Header & User ID Display -->
        <header class="text-center mb-10 p-4 bg-white/10 backdrop-blur-md rounded-2xl shadow-lg">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">
                NovaFit Tracker
            </h1>
            <p class="text-sm text-white/70 mt-2">
                Your Fitness Dashboard | Data synced with Firebase
            </p>
            <div class="mt-3 text-xs text-white/50">
                User ID: <span id="user-id-display" class="font-mono text-purple-300 break-all">Authenticating...</span>
            </div>
        </header>

        <!-- Main Dashboard Layout -->
        <main id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Column 1: Daily Goals & Progress -->
            <section class="lg:col-span-1 space-y-8">
                
                <!-- Daily Goals Card -->
                <div class="daily-goal-card p-6 rounded-2xl shadow-xl transition duration-300">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-purple-300">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 001 1h3m-6-8h4m-4 0h.01"></path></svg>
                        Daily Goal Progress
                    </h2>
                    
                    <div id="progress-container" class="space-y-4">
                        <p class="text-center text-gray-500">Loading goals...</p>
                    </div>

                    <button id="goal-edit-button" onclick="showModal('goal-modal')" class="w-full mt-6 py-2 px-4 rounded-xl font-semibold text-sm bg-purple-600 hover:bg-purple-700 transition duration-300 shadow-md shadow-purple-500/50" disabled>
                        Edit Goals
                    </button>
                </div>
                
                <!-- Profile Card -->
                <div class="p-6 rounded-2xl shadow-xl bg-white/10 backdrop-blur-md border-cyan-500/30 border transition duration-300">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-cyan-300">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        Profile
                    </h2>
                    <div id="profile-display" class="text-lg space-y-2">
                         <p class="text-center text-gray-500">Loading profile...</p>
                    </div>
                    <button id="profile-edit-button" onclick="showModal('profile-modal')" class="w-full mt-6 py-2 px-4 rounded-xl font-semibold text-sm bg-cyan-600 hover:bg-cyan-700 transition duration-300 shadow-md shadow-cyan-500/50" disabled>
                        Update Profile
                    </button>
                </div>

            </section>
            
            <!-- Column 2: Activity Entry & Visualization -->
            <section class="lg:col-span-2 space-y-8">
                
                <!-- Manual Activity Entry Card -->
                <div id="entry-card" class="relative p-6 rounded-2xl shadow-xl bg-white/10 backdrop-blur-md border-green-500/30 border transition duration-300">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-green-300">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Manual Activity Entry
                    </h2>
                    
                    <!-- Loading Overlay -->
                    <div id="manual-entry-form-loading">
                        <div class="spinner"></div>
                        <span class="text-gray-400 font-medium">Connecting to NovaFit...</span>
                    </div>

                    <form id="manual-entry-form" class="space-y-4">
                        <input type="text" id="activity-name" placeholder="Activity Name (e.g., Running)" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-green-500 focus:border-green-500 text-white" disabled>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="activity-calories" placeholder="Calories Burned" required min="1" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-green-500 focus:border-green-500 text-white" disabled>
                            <input type="number" id="activity-duration" placeholder="Duration (min)" required min="1" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-green-500 focus:border-green-500 text-white" disabled>
                        </div>
                        <button type="submit" class="w-full py-3 px-4 rounded-xl font-bold bg-green-600 hover:bg-green-700 transition duration-300 shadow-lg shadow-green-500/50" disabled>
                            Log Activity
                        </button>
                    </form>
                </div>
                
                <!-- Weekly Calorie Burn Chart -->
                <div class="p-6 rounded-2xl shadow-xl bg-white/10 backdrop-blur-md border-pink-500/30 border transition duration-300">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-pink-300">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M12 16h2m-2-6h2m0 0h2M12 6h2m-2-6h2m0 0h2m-7 4l-3 3 3 3 4-4M16 12h-4m4 0h.01M16 16h-4m4 0h.01M20 7v10a3 3 0 01-3 3H7a3 3 0 01-3-3V7a3 3 0 013-3h10a3 3 0 013 3z"></path></svg>
                        Weekly Calorie Burn
                    </h2>
                    <div class="h-64">
                        <canvas id="weekly-calorie-chart"></canvas>
                    </div>
                </div>

            </section>
            
            <!-- Column 3: Activity Log (Moved to be visible on smaller screens too) -->
            <section class="lg:col-span-3 space-y-8">
                <!-- Activity Log Card -->
                <div class="activity-log-card p-6 rounded-2xl shadow-xl transition duration-300">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-blue-300">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        Recent Activity Log
                    </h2>
                    <ul id="activity-log-list" class="space-y-3">
                        <li class="text-center text-white/50 italic">Log is loading from Firebase...</li>
                    </ul>
                    <div class="mt-6 flex justify-end">
                        <button id="clear-log-button" class="py-2 px-4 rounded-xl font-semibold text-xs bg-red-600 hover:bg-red-700 transition duration-300 shadow-md shadow-red-500/50" disabled>
                            Clear Log
                        </button>
                    </div>
                </div>
            </section>
            
        </main>

        <!-- Modals -->
        
        <!-- Profile Modal -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" onclick="if(event.target.id === 'profile-modal') hideModal('profile-modal')">
            <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-md shadow-2xl border border-cyan-400/50">
                <h3 class="text-2xl font-bold mb-6 text-cyan-300">Update Profile</h3>
                <form id="profile-form" class="space-y-4">
                    <input type="text" id="profile-name" placeholder="Name" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500 text-white">
                    <div class="flex space-x-4">
                        <select id="profile-gender" required class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500 text-white">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <input type="number" id="profile-weight" placeholder="Weight (kg)" required min="1" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500 text-white">
                    </div>
                    <input type="number" id="profile-height" placeholder="Height (cm)" required min="1" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-cyan-500 focus:border-cyan-500 text-white">
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" onclick="hideModal('profile-modal')" class="py-2 px-4 rounded-xl font-semibold bg-gray-600 hover:bg-gray-700 transition duration-300">Cancel</button>
                        <button type="submit" class="py-2 px-4 rounded-xl font-semibold bg-cyan-600 hover:bg-cyan-700 transition duration-300">Save Profile</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Goal Modal -->
        <div id="goal-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" onclick="if(event.target.id === 'goal-modal') hideModal('goal-modal')">
            <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-md shadow-2xl border border-purple-400/50">
                <h3 class="text-2xl font-bold mb-6 text-purple-300">Update Daily Goals</h3>
                <form id="goal-form" class="space-y-4">
                    <input type="number" id="goal-calories" placeholder="Calorie Target (kcal)" required min="1" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white">
                    <div class="grid grid-cols-3 gap-4">
                        <input type="number" id="goal-protein" placeholder="Protein (g)" required min="0" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white">
                        <input type="number" id="goal-carbs" placeholder="Carbs (g)" required min="0" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white">
                        <input type="number" id="goal-fat" placeholder="Fat (g)" required min="0" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-purple-500 focus:border-purple-500 text-white">
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" onclick="hideModal('goal-modal')" class="py-2 px-4 rounded-xl font-semibold bg-gray-600 hover:bg-gray-700 transition duration-300">Cancel</button>
                        <button type="submit" class="py-2 px-4 rounded-xl font-semibold bg-purple-600 hover:bg-purple-700 transition duration-300">Save Goals</button>
                    </div>
                </form>
            </div>
        </div>

    </div>
    
    <script>
        
        let chartInstance = null; // Variable to hold the Chart.js instance

        /**
         * Custom toast message for feedback, replacing alert().
         * @param {string} message The message to display.
         * @param {'success'|'error'} type The type of toast.
         */
        function messageToast(message, type = 'success') {
            const toast = document.getElementById('message-toast');
            toast.textContent = message;
            toast.className = 'font-semibold'; // Reset classes
            toast.classList.add(`toast-${type}`);
            
            // Show the toast
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(-50%) translateY(0)';

            // Hide the toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(20px)';
            }, 3000);
        }
        window.messageToast = messageToast; // Make available globally for module script

        // --- Core Application Logic ---
        
        /**
         * Renders the circular progress bar for a single goal.
         */
        function renderProgressRing(type, current, target, color, unit) {
            const radius = 40;
            const circumference = 2 * Math.PI * radius;
            const progress = target > 0 ? Math.min(100, (current / target) * 100) : 0;
            const offset = circumference - (progress / 100) * circumference;
            const displayValue = current > target ? `<span class="text-xl font-extrabold text-${color}-400">GOAL!</span>` : `${Math.round(progress)}%`;

            return `
                <div class="flex items-center space-x-4 p-3 bg-gray-800/50 rounded-xl border border-gray-700">
                    <svg class="w-24 h-24" viewBox="0 0 100 100">
                        <!-- Background ring -->
                        <circle
                            class="text-gray-600"
                            stroke="currentColor"
                            stroke-width="8"
                            fill="transparent"
                            r="${radius}"
                            cx="50"
                            cy="50"
                        />
                        <!-- Progress ring -->
                        <circle
                            class="progress-ring__circle text-${color}-500"
                            stroke="currentColor"
                            stroke-width="8"
                            stroke-linecap="round"
                            fill="transparent"
                            r="${radius}"
                            cx="50"
                            cy="50"
                            style="stroke-dasharray: ${circumference} ${circumference}; stroke-dashoffset: ${offset};"
                        />
                        <!-- Text center -->
                        <g class="text-white text-center" transform="translate(50, 50)">
                            <text dominant-baseline="middle" text-anchor="middle" y="-5" class="text-lg font-bold">
                                ${displayValue}
                            </text>
                            <text dominant-baseline="middle" text-anchor="middle" y="15" class="text-xs text-gray-400 font-medium">
                                ${type.toUpperCase()}
                            </text>
                        </g>
                    </svg>
                    <div class="flex-1">
                        <p class="text-lg font-semibold capitalize">${type}</p>
                        <p class="text-sm text-gray-300">Achieved: <span class="text-${color}-300 font-bold">${current}${unit}</span></p>
                        <p class="text-xs text-gray-400">Target: ${target}${unit}</p>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the weekly calorie burn chart using Chart.js.
         */
        function renderChart() {
            const ctx = document.getElementById('weekly-calorie-chart').getContext('2d');
            
            // Calculate weekly data (last 7 days of log entries)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const weeklyData = {};
            const dateFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short' });

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                const dayLabel = dateFormatter.format(date);
                weeklyData[dateKey] = { label: dayLabel, calories: 0 };
            }

            // Aggregate data from log
            window.data.log.forEach(entry => {
                // Ensure entry.timestamp is a string, then check if it starts with the date part.
                const entryDate = String(entry.timestamp).split('T')[0]; 
                if (weeklyData[entryDate]) {
                    weeklyData[entryDate].calories += entry.calories;
                }
            });

            const labels = Object.values(weeklyData).map(d => d.label);
            const calories = Object.values(weeklyData).map(d => d.calories);

            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = calories;
                chartInstance.update();
                return;
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calories Burned (kcal)',
                        data: calories,
                        backgroundColor: 'rgba(236, 72, 153, 0.7)', // pink-500
                        borderColor: '#ec4899',
                        borderWidth: 1,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#e5e5e5' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#e5e5e5' }
                        }
                    }
                }
            });
        }

        /**
         * The main render function called after any data change (from form or Firestore).
         */
        function renderApp() {
            // Calculate today's progress
            const today = new Date().toISOString().split('T')[0];
            const todayLog = window.data.log.filter(entry => String(entry.timestamp).startsWith(today));

            const totalBurned = todayLog.reduce((sum, entry) => sum + entry.calories, 0);
            const totalProtein = 0; // Simplified: focusing on activity calories
            const totalCarbs = 0;
            const totalFat = 0;
            
            // 1. Render Progress Rings
            const progressContainer = document.getElementById('progress-container');
            const goal = window.data.goal;
            progressContainer.innerHTML = [
                renderProgressRing('calories', totalBurned, goal.calories, 'purple', 'kcal'),
                renderProgressRing('protein', totalProtein, goal.protein, 'cyan', 'g'),
                renderProgressRing('carbs', totalCarbs, goal.carbs, 'yellow', 'g'),
                renderProgressRing('fat', totalFat, goal.fat, 'red', 'g'),
            ].join('');

            // 2. Render Profile Display
            const profileDisplay = document.getElementById('profile-display');
            const p = window.data.profile;
            profileDisplay.innerHTML = `
                <p><strong>Name:</strong> ${p.name}</p>
                <p><strong>Gender:</strong> ${p.gender.charAt(0).toUpperCase() + p.gender.slice(1)}</p>
                <p><strong>Weight:</strong> ${p.weight} kg</p>
                <p><strong>Height:</strong> ${p.height} cm</p>
            `;

            // 3. Render Activity Log
            const logList = document.getElementById('activity-log-list');
            
            if (window.data.log.length === 0) {
                logList.innerHTML = '<li class="text-center text-white/50 italic">No activities logged yet.</li>';
            } else {
                // Sort by timestamp (newest first)
                const sortedLog = [...window.data.log].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                logList.innerHTML = sortedLog.map(entry => {
                    const time = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const date = new Date(entry.timestamp).toLocaleDateString();
                    return `
                        <li class="p-3 bg-gray-800/50 rounded-lg shadow-inner flex justify-between items-center text-sm">
                            <div>
                                <strong class="text-green-300">${entry.name}</strong> (${entry.duration} min)
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-gray-400">${date} ${time}</span>
                                <p class="text-md font-bold text-red-400">-${entry.calories} kcal</p>
                            </div>
                        </li>
                    `;
                }).slice(0, 10).join(''); // Show only the 10 most recent activities
            }
            
            // 4. Render Chart
            renderChart();
            
            // 5. Update Modals with current data for editing
            document.getElementById('profile-name').value = p.name;
            document.getElementById('profile-gender').value = p.gender;
            document.getElementById('profile-weight').value = p.weight;
            document.getElementById('profile-height').value = p.height;
            
            document.getElementById('goal-calories').value = goal.calories;
            document.getElementById('goal-protein').value = goal.protein;
            document.getElementById('goal-carbs').value = goal.carbs;
            document.getElementById('goal-fat').value = goal.fat;
        }
        window.renderApp = renderApp; // Make available globally for module script


        // --- Setup Functions (Only called when auth is ready) ---
        
        /**
         * Enables all interactive elements and attaches listeners.
         */
        function setupAppListeners() {
            // Remove loading state overlay from activity entry
            document.getElementById('manual-entry-form-loading').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('manual-entry-form-loading').style.display = 'none';
            }, 300);

            // Enable buttons and inputs
            document.getElementById('goal-edit-button').disabled = false;
            document.getElementById('profile-edit-button').disabled = false;
            document.getElementById('clear-log-button').disabled = false;

            document.getElementById('activity-name').disabled = false;
            document.getElementById('activity-calories').disabled = false;
            document.getElementById('activity-duration').disabled = false;
            document.querySelector('#manual-entry-form button[type="submit"]').disabled = false;

            // Attach form handlers
            setupProfileForms();
            setupManualEntry();
            setupGoalForm();
            setupClearLog();

            // Apply initial dark mode styling to static cards
            document.querySelector('.daily-goal-card').classList.add('bg-white/10', 'backdrop-blur-md', 'border-purple-500/30', 'border');
            document.querySelector('.activity-log-card').classList.add('bg-white/10', 'backdrop-blur-md', 'border-blue-500/30', 'border');
        }
        window.setupAppListeners = setupAppListeners; // Expose globally to be called by the module script


        function setupProfileForms() {
            document.getElementById('profile-form').onsubmit = function(event) {
                event.preventDefault();
                window.data.profile.name = document.getElementById('profile-name').value;
                window.data.profile.gender = document.getElementById('profile-gender').value;
                window.data.profile.weight = parseInt(document.getElementById('profile-weight').value);
                window.data.profile.height = parseInt(document.getElementById('profile-height').value);
                
                // Call the module-exported save function
                window.saveDataToFirestore();
                hideModal('profile-modal');
            };
        }

        function setupGoalForm() {
            document.getElementById('goal-form').onsubmit = function(event) {
                event.preventDefault();
                window.data.goal.calories = parseInt(document.getElementById('goal-calories').value);
                window.data.goal.protein = parseInt(document.getElementById('goal-protein').value);
                window.data.goal.carbs = parseInt(document.getElementById('goal-carbs').value);
                window.data.goal.fat = parseInt(document.getElementById('goal-fat').value);
                
                // Call the module-exported save function
                window.saveDataToFirestore();
                hideModal('goal-modal');
            };
        }

        function setupManualEntry() {
            document.getElementById('manual-entry-form').onsubmit = function(event) {
                event.preventDefault();
                
                const name = document.getElementById('activity-name').value;
                const calories = parseInt(document.getElementById('activity-calories').value);
                const duration = parseInt(document.getElementById('activity-duration').value);
                
                if (name && calories > 0 && duration > 0) {
                    const newActivity = {
                        name: name,
                        calories: calories,
                        duration: duration,
                        timestamp: new Date().toISOString()
                    };
                    
                    window.data.log.push(newActivity);
                    
                    // Clear form
                    document.getElementById('activity-name').value = '';
                    document.getElementById('activity-calories').value = '';
                    document.getElementById('activity-duration').value = '';

                    // Call the module-exported save function
                    window.saveDataToFirestore();
                } else {
                    messageToast('Please fill out all fields correctly.', 'error');
                }
            };
        }
        
        function setupClearLog() {
            document.getElementById('clear-log-button').onclick = function() {
                // Using the fallback confirmation function
                if (window.confirm("Are you sure you want to clear the entire activity log? This cannot be undone.")) {
                    window.data.log = [];
                    // Call the module-exported save function
                    window.saveDataToFirestore();
                    messageToast('Activity log cleared.', 'error');
                }
            };
        }
        
        // Custom confirmation function to replace window.confirm()
        function confirmAction(message) {
             console.warn(`Assuming confirmation for action: ${message}`);
             // This is a placeholder. In a full production app, this would show a custom modal.
             return true; 
        }
        window.confirm = confirmAction;

        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- Particle Generation ---
        function generateParticles() {
            const container = document.getElementById('particles-container');
            const particleCount = 20;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';

                // Random size and position
                const size = Math.random() * 8 + 4; // 4px to 12px
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}vw`;
                
                // Random animation duration and delay
                const duration = Math.random() * 15 + 10; // 10s to 25s
                particle.style.animationDuration = `${duration}s, ${Math.random() * 5 + 5}s`; // Two animations: move and flow
                particle.style.animationDelay = `-${Math.random() * duration}s, -${Math.random() * duration}s`;

                // Random flow offsets (for the CSS variable in the flow keyframe)
                const flowX = Math.random() * 200 - 100; 
                const flowY = Math.random() * 200 - 100; 
                particle.style.setProperty('--flow-x', `${flowX}px`);
                particle.style.setProperty('--flow-y', `${flowY}px`);

                container.appendChild(particle);
            }
        }


        // --- Application Initialization ---

        /**
         * The main initialization function for the app.
         */
        function initApp() {
            // Start the visual elements immediately
            generateParticles();
            
            // Only initialize Firebase. The rest of the setup waits for auth completion inside the module.
            window.initializeFirebase(); 
        }

        // Initialize the application when the window loads
        window.onload = initApp;

    </script>
</body>
</html>
