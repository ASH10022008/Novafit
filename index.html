<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaFit Tracker - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            query, 
            where, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase services to the global scope for use in the main script
        window.firebase = {
            initializeApp,
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection, 
            query, 
            where, 
            getDocs
        };
    </script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            transition: background-color 0.5s, color 0.5s;
        }
        /* --- Dark Mode Styles (Default) --- */
        .neon-gradient {
            background: linear-gradient(135deg, #0f172a, #7e22ce, #06b6d4);
            background-size: 600% 600%;
            animation: gradientShift 16s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- Particle System Styles --- */
        #particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .particle {
            position: absolute;
            background: rgba(126, 34, 206, 0.6); /* Purple/Neon */
            border-radius: 50%;
            opacity: 0;
            animation: flow ease-in-out infinite;
        }

        @keyframes flow {
            0% { 
                transform: translate(0, 0) scale(0.5); 
                opacity: 0;
            }
            5% { opacity: 1; }
            95% { opacity: 0; }
            100% { 
                transform: translate(var(--flow-x), var(--flow-y)) scale(1.5);
                opacity: 0;
            }
        }
        
        /* Custom style for the circular progress bar */
        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Chart.js styles for dark mode */
        .chart-container canvas {
            background-color: transparent !important;
        }
    </style>
</head>
<body class="neon-gradient text-white flex items-center justify-center min-h-screen p-4">

    <!-- Particle Container -->
    <div id="particles-container"></div>

    <!-- Main Application Container -->
    <div id="app-container" class="relative z-10 w-full max-w-4xl">
        <!-- Content will be rendered here based on auth state and current view -->
    </div>


    <script>
        // Use an IIFE (Immediately Invoked Function Expression) to protect global scope
        (function() {
            // --- Global State & Constants ---
            // Fallback for global variables in case of environment differences
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            let app;
            let db;
            let auth;
            let userId = null;
            let isAuthReady = false;
            let currentView = 'dashboard'; // Can be 'dashboard', 'profile', 'charts'
            let isRegistering = false; // State for the registration button

            // Initialize appData with default structure
            let appData = {
                username: null,
                profile: {
                    weight: 75, // kg
                    height: 175, // cm
                    age: 30,
                    gender: 'Male'
                },
                goal: {
                    dailySteps: 10000,
                    dailyCalories: 500,
                },
                activityLog: [], // { id, type, value, calories, date }
            };

            const COLLECTION_NAME = 'novafit';
            const USER_DOC_PATH = (uid) => `artifacts/${appId}/users/${uid}/${COLLECTION_NAME}/data`;
            // Uses a unique document ID based on the username for easy lookup in the public collection
            const USERNAME_CHECK_PATH = (username) => `artifacts/${appId}/public/data/${COLLECTION_NAME}/usernames/${username.toLowerCase()}`;

            // --- Utility Functions ---

            /**
             * Calculates the circumference for the progress circle.
             * @param {number} radius - The radius of the circle.
             * @returns {number} The circumference.
             */
            function getCircumference(radius) {
                return 2 * Math.PI * radius;
            }

            /**
             * Renders the circular progress bar.
             * @param {number} percentage - The completion percentage (0-100).
             * @param {string} targetElementId - The ID of the container to render into.
             * @param {number} size - Width/Height of the SVG.
             * @param {number} strokeWidth - Thickness of the stroke.
             */
            function renderProgressRing(percentage, targetElementId, size = 120, strokeWidth = 8) {
                const element = document.getElementById(targetElementId);
                if (!element) return;

                const radius = (size / 2) - (strokeWidth / 2);
                const circumference = getCircumference(radius);
                const offset = circumference - (percentage / 100) * circumference;

                element.innerHTML = `
                    <svg class="progress-ring" width="${size}" height="${size}">
                        <!-- Background Circle -->
                        <circle
                            stroke="#4b5563"
                            fill="transparent"
                            stroke-width="${strokeWidth}"
                            r="${radius}"
                            cx="${size / 2}"
                            cy="${size / 2}"
                            class="opacity-50"
                        />
                        <!-- Foreground Progress Circle -->
                        <circle
                            id="progress-circle-${targetElementId}"
                            stroke="#a78bfa"
                            fill="transparent"
                            stroke-width="${strokeWidth}"
                            stroke-linecap="round"
                            r="${radius}"
                            cx="${size / 2}"
                            cy="${size / 2}"
                            stroke-dasharray="${circumference} ${circumference}"
                            stroke-dashoffset="${offset}"
                            class="progress-ring__circle shadow-lg shadow-purple-500/50"
                        />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                        <span class="text-2xl font-bold">${Math.round(percentage)}%</span>
                        <span class="text-xs text-gray-300">Goal Met</span>
                    </div>
                `;
            }

            /**
             * Creates and starts the particle background animation.
             */
            function generateParticles() {
                const container = document.getElementById('particles-container');
                if (!container) return;
                const numberOfParticles = 20;

                for (let i = 0; i < numberOfParticles; i++) {
                    const particle = document.createElement('div');
                    particle.classList.add('particle', 'bg-purple-400', 'shadow-lg', 'shadow-purple-500/50');
                    
                    const size = Math.random() * 8 + 4; // Size between 4px and 12px
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;

                    const duration = Math.random() * 10 + 10; // Duration between 10s and 20s
                    particle.style.animationDuration = `${duration}s, ${duration}s`;
                    
                    const positionX = Math.random() * 100; // 0 to 100%
                    const positionY = Math.random() * 100;
                    particle.style.left = `${positionX}%`;
                    particle.style.top = `${positionY}%`;
                    
                    // Random animation delay for staggering
                    particle.style.animationDelay = `-${Math.random() * duration}s, -${Math.random() * duration}s`;

                    // Random flow offsets (for the CSS variable in the flow keyframe)
                    const flowX = Math.random() * 200 - 100;
                    const flowY = Math.random() * 200 - 100;
                    particle.style.setProperty('--flow-x', `${flowX}px`);
                    particle.style.setProperty('--flow-y', `${flowY}px`);

                    container.appendChild(particle);
                }
            }

            /**
             * Custom alert/message box function.
             * @param {string} message - The message to display.
             */
            function showMessage(message) {
                const container = document.getElementById('message-container');
                if (!container) return;

                const messageBox = document.createElement('div');
                messageBox.classList.add(
                    'fixed', 'bottom-4', 'right-4', 'bg-gray-800', 'text-white', 'p-4', 
                    'rounded-lg', 'shadow-2xl', 'z-50', 'animate-pulse'
                );
                messageBox.textContent = message;

                container.appendChild(messageBox);
                
                setTimeout(() => {
                    messageBox.remove();
                }, 3000); // Remove after 3 seconds
            }

            /**
             * Fallback/mock for window.confirm() in restricted environments.
             * @returns {boolean} Returns true to allow the action to proceed.
             */
            function confirmAction(message) {
                 console.warn(`Assuming confirmation for action: ${message}`);
                 return true;
            }


            // --- Firebase Data Handling ---

            /**
             * Loads user data from Firestore.
             */
            async function loadFirestoreData() {
                if (!db || !userId) return;

                try {
                    const docRef = firebase.doc(db, USER_DOC_PATH(userId));
                    const docSnap = await firebase.getDoc(docRef);

                    if (docSnap.exists()) {
                        console.log("Document data loaded successfully:", docSnap.data());
                        const loadedData = docSnap.data();
                        
                        // Merge loaded data with default structure
                        appData = {
                            ...appData,
                            ...loadedData,
                            profile: { ...appData.profile, ...(loadedData.profile || {}) },
                            goal: { ...appData.goal, ...(loadedData.goal || {}) },
                            activityLog: Array.isArray(loadedData.activityLog) 
                                ? loadedData.activityLog 
                                : (typeof loadedData.activityLog === 'string' ? JSON.parse(loadedData.activityLog) : [])
                        };

                    } else {
                        console.log("No user document found. Using default data.");
                        // If no document exists, the user is new, so we proceed with default data.
                    }

                } catch (error) {
                    console.error("Error loading data from Firestore:", error);
                    showMessage("Error loading data. Check console for details.");
                }
                
                renderApp(); // Re-render once data is loaded/initialized
            }

            /**
             * Saves all app data to Firestore.
             */
            async function saveFirestoreData() {
                if (!db || !userId || !appData.username) return; // Must have a user ID and username to save

                try {
                    const docRef = firebase.doc(db, USER_DOC_PATH(userId));
                    
                    const dataToSave = {
                        ...appData,
                        activityLog: appData.activityLog
                    };

                    await firebase.setDoc(docRef, dataToSave, { merge: true });
                    console.log("Data saved to Firestore successfully.");
                } catch (error) {
                    console.error("Error saving data to Firestore:", error);
                    showMessage("Error saving progress. Check console for details.");
                }
            }


            /**
             * Registers a new unique username for the currently signed-in user.
             * This function resolves the "stuck on checking" issue.
             * @param {string} username - The desired unique username.
             */
            async function registerUser(username) {
                console.log("Attempting to register username:", username);
                if (!db || !userId) {
                    showMessage("Authentication not ready or User ID missing. Please wait 5 seconds.");
                    console.error("Registration failed: DB or UserID missing.", { db: !!db, userId });
                    return;
                }
                if (isRegistering) return;
                isRegistering = true;
                renderAuthScreen(); // Update button state to "Checking..."

                try {
                    // 1. Check uniqueness
                    console.log("1. Checking if username is unique...");
                    const usernameRef = firebase.doc(db, USERNAME_CHECK_PATH(username));
                    const usernameDoc = await firebase.getDoc(usernameRef);

                    if (usernameDoc.exists()) {
                        showMessage(`Username '${username}' is already taken.`);
                        console.warn("Registration failed: Username already exists.");
                        isRegistering = false;
                        renderAuthScreen(); // Reset button
                        return;
                    }
                    
                    // 2. Create the public username mapping (marks it as taken)
                    console.log("2. Username is unique. Creating public mapping...");
                    await firebase.setDoc(usernameRef, { 
                        userId: userId, 
                        createdAt: new Date().toISOString() 
                    });
                    
                    // 3. Save the username to the user's private data
                    console.log("3. Saving username to private user document...");
                    appData.username = username;
                    await saveFirestoreData();

                    // 4. Success and cleanup
                    console.log("4. Registration success! Transitioning to dashboard.");
                    showMessage(`Welcome, ${username}! Registration successful.`);
                    isRegistering = false;
                    renderApp(); // Rerender to show the dashboard
                    
                } catch (error) {
                    console.error("CRITICAL ERROR during registration:", error);
                    showMessage("Registration failed due to a database error. Check the console for details (F12).");
                    isRegistering = false;
                    renderAuthScreen(); // Reset button on error
                }
            }

            /**
             * Attempts to log in with an existing username.
             * SIMPLIFIED: If the username exists publicly, we treat the current authenticated user as that user.
             */
            async function loginUser(username) {
                console.log("Attempting to log in as:", username);
                if (!db || !userId) {
                    showMessage("Authentication not ready. Please wait.");
                    return;
                }
                
                if (isRegistering) return; // Re-using this state for simplicity
                isRegistering = true;
                renderAuthScreen();

                try {
                    const usernameRef = firebase.doc(db, USERNAME_CHECK_PATH(username));
                    const usernameDoc = await firebase.getDoc(usernameRef);
                    
                    if (usernameDoc.exists()) {
                        console.log("Username found. Associating with current user ID:", userId);
                        // Username exists publicly. Set this username on the current authenticated user's profile.
                        appData.username = username;
                        // Save to private doc to ensure persistence across sessions
                        await saveFirestoreData(); 

                        showMessage(`Logged in as ${username}.`);
                        isRegistering = false;
                        renderApp();
                    } else {
                        showMessage(`Username '${username}' not found. Please register.`);
                        isRegistering = false;
                        renderAuthScreen();
                    }
                } catch (error) {
                    console.error("Error logging in:", error);
                    showMessage("Login failed. Check console for details.");
                    isRegistering = false;
                    renderAuthScreen();
                }
            }

            // --- UI Rendering ---

            /**
             * Renders the main application view based on the current state.
             */
            function renderApp() {
                const container = document.getElementById('app-container');
                if (!container) return;
                
                // Show Auth Screen if username is null or auth is not ready
                if (!appData.username || !isAuthReady) {
                    renderAuthScreen();
                    return;
                }

                // Otherwise, show the main dashboard/content
                let content = '';

                const bmi = calculateBMI();
                const progressSteps = calculateProgress('steps');
                const progressCalories = calculateProgress('calories');

                // Generate appropriate view content
                switch (currentView) {
                    case 'profile':
                        content = renderProfileView();
                        break;
                    case 'charts':
                        content = renderChartsView();
                        break;
                    case 'dashboard':
                    default:
                        content = renderDashboardView(bmi, progressSteps, progressCalories);
                        break;
                }

                container.innerHTML = `
                    <div id="message-container"></div>
                    ${renderNavigationView()}
                    <div class="mt-8">
                        ${content}
                    </div>
                `;

                // After rendering, setup interactive elements and progress rings
                setupProfileForms();
                setupManualEntry();
                setupGoalForm();
                setupClearLog();
                
                if (currentView === 'dashboard') {
                    renderProgressRing(progressSteps, 'steps-progress', 120, 8);
                    renderProgressRing(progressCalories, 'calories-progress', 120, 8);
                }
                
                if (currentView === 'charts') {
                    // Only load Chart.js script if the chart view is visible
                    if (typeof Chart !== 'undefined') {
                        renderCharts();
                    } else {
                        console.error("Chart.js not loaded.");
                    }
                }

                // Set up navigation listeners again after content refresh
                setupNavigation();
            }

            /**
             * Renders the authentication and welcome screen.
             */
            function renderAuthScreen() {
                const container = document.getElementById('app-container');
                if (!container) return;

                const buttonText = isRegistering ? 'Checking Username...' : 'Register';

                container.innerHTML = `
                    <div class="min-h-[60vh] flex flex-col items-center justify-center p-6 bg-white/10 backdrop-blur-lg rounded-xl shadow-2xl border border-blue-500/30">
                        <h1 class="text-4xl font-extrabold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">
                            Welcome to NovaFit
                        </h1>
                        <p class="text-gray-300 mb-8 text-center max-w-md">
                            Your fitness journey starts here. Please choose a unique username to register or login.
                        </p>

                        <div class="w-full max-w-xs space-y-4">
                            <input 
                                type="text" 
                                id="username-input" 
                                placeholder="Enter Unique Username" 
                                class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-purple-500 border border-gray-600 outline-none"
                                value=""
                            />
                            <div class="flex space-x-2">
                                <button 
                                    id="register-btn" 
                                    class="flex-1 p-3 rounded-lg font-bold text-white transition duration-300 shadow-md shadow-purple-500/50 
                                        ${isRegistering ? 'bg-gray-500 cursor-not-allowed' : 'bg-purple-600 hover:bg-purple-700 active:scale-95'}"
                                    ${isRegistering ? 'disabled' : ''}
                                >
                                    ${buttonText}
                                </button>
                                <button 
                                    id="login-btn" 
                                    class="flex-1 p-3 rounded-lg font-bold text-white transition duration-300 border border-cyan-500 
                                        ${isRegistering ? 'bg-gray-500 cursor-not-allowed' : 'bg-transparent hover:bg-cyan-500/20 active:scale-95'}"
                                    ${isRegistering ? 'disabled' : ''}
                                >
                                    Login
                                </button>
                            </div>
                        </div>

                        ${!isAuthReady 
                            ? `<p class="mt-4 text-sm text-yellow-400">Connecting to database...</p>` 
                            : `<p class="mt-4 text-sm text-gray-400">User ID: ${userId || 'N/A'}</p>`
                        }
                    </div>
                `;

                // Setup listeners for the auth buttons
                document.getElementById('register-btn')?.addEventListener('click', () => {
                    const username = document.getElementById('username-input').value.trim();
                    if (username) registerUser(username);
                });
                document.getElementById('login-btn')?.addEventListener('click', () => {
                    const username = document.getElementById('username-input').value.trim();
                    if (username) loginUser(username);
                });
            }

            // --- Other View Rendering Functions (Dashboard, Profile, Charts) ---

            function renderNavigationView() {
                 return `
                    <nav class="bg-white/10 backdrop-blur-md rounded-xl p-3 shadow-xl mb-6 flex justify-between items-center border border-gray-600">
                        <div class="flex items-center space-x-3">
                            <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9h-9m4 0h1a1 1 0 001-1v-1m-4 4h1a1 1 0 011-1v-1m-4 4v2m-5-4v2m-5-4v2M3 12h9m-9 0a9 9 0 009 9m-9-9a9 9 0 019-9"></path>
                            </svg>
                            <span class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">NovaFit</span>
                        </div>
                        <div class="flex space-x-2">
                            <button id="nav-dashboard" class="p-2 rounded-full transition duration-150 ${currentView === 'dashboard' ? 'bg-purple-500 shadow-lg shadow-purple-500/50' : 'text-gray-300 hover:bg-white/20'}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2-2m-2 2l-7 7m7-7v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                            </button>
                            <button id="nav-charts" class="p-2 rounded-full transition duration-150 ${currentView === 'charts' ? 'bg-purple-500 shadow-lg shadow-purple-500/50' : 'text-gray-300 hover:bg-white/20'}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.957 9.957 0 0112 12m0 0v10m0-10a9.957 9.957 0 017.962 4.038m-7.962-4.038A9.957 9.957 0 004.038 12m7.962 0h-9m9 0h9m-9 0v-9"></path></svg>
                            </button>
                            <button id="nav-profile" class="p-2 rounded-full transition duration-150 ${currentView === 'profile' ? 'bg-purple-500 shadow-lg shadow-purple-500/50' : 'text-gray-300 hover:bg-white/20'}">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A8.997 8.997 0 0112 15c2.035 0 3.931.785 5.399 2.196m-10.798 0l-.398.397m11.596-.397l.398.397M12 12a3 3 0 100-6 3 3 0 000 6z"></path></svg>
                            </button>
                        </div>
                    </nav>
                    <p class="text-sm text-center text-gray-400 mb-4">Logged in as: ${appData.username} (${userId})</p>
                `;
            }

            function renderDashboardView(bmi, progressSteps, progressCalories) {
                const totalSteps = appData.activityLog
                    .filter(a => a.type === 'steps')
                    .reduce((sum, a) => sum + parseInt(a.value), 0);
                const totalCalories = appData.activityLog
                    .filter(a => a.type !== 'steps')
                    .reduce((sum, a) => sum + parseInt(a.calories), 0);

                return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Goal Progress Card -->
                        <div class="md:col-span-2 daily-goal-card p-6 rounded-xl shadow-2xl transition duration-300 bg-white/10 backdrop-blur-md border border-purple-500/30">
                            <h2 class="text-2xl font-bold mb-4 text-purple-400">Daily Goal Progress</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="p-4 rounded-lg bg-white/5 flex flex-col items-center">
                                    <h3 class="text-lg font-semibold text-cyan-400 mb-2">Steps Goal</h3>
                                    <div id="steps-progress" class="relative"></div>
                                    <p class="mt-2 text-sm text-gray-300">${totalSteps.toLocaleString()} / ${appData.goal.dailySteps.toLocaleString()} steps</p>
                                </div>
                                <div class="p-4 rounded-lg bg-white/5 flex flex-col items-center">
                                    <h3 class="text-lg font-semibold text-purple-400 mb-2">Calorie Burn Goal</h3>
                                    <div id="calories-progress" class="relative"></div>
                                    <p class="mt-2 text-sm text-gray-300">${totalCalories.toLocaleString()} / ${appData.goal.dailyCalories.toLocaleString()} kcal</p>
                                </div>
                            </div>
                            <div id="goal-message" class="mt-4 text-center text-lg font-medium text-green-400">
                                ${progressSteps >= 100 && progressCalories >= 100 ? "Amazing work! Goals achieved." : "Keep pushing, you're doing great!"}
                            </div>
                        </div>

                        <!-- Manual Entry Card -->
                        <div class="daily-goal-card p-6 rounded-xl shadow-2xl transition duration-300 bg-white/10 backdrop-blur-md border border-blue-500/30">
                            <h2 class="text-2xl font-bold mb-4 text-blue-400">Log Activity</h2>
                            <form id="manual-entry-form" class="space-y-3">
                                <div>
                                    <label for="activity-type" class="block text-sm font-medium text-gray-300">Activity Type</label>
                                    <select id="activity-type" class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border border-gray-600 outline-none">
                                        <option value="Running">Running</option>
                                        <option value="Cycling">Cycling</option>
                                        <option value="Walking">Walking</option>
                                        <option value="Weights">Weights</option>
                                        <option value="Steps" selected>Steps</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="activity-value" class="block text-sm font-medium text-gray-300">Value (e.g., Steps, Minutes)</label>
                                    <input type="number" id="activity-value" placeholder="Enter value" required class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border border-gray-600 outline-none">
                                </div>
                                <div>
                                    <label for="activity-calories" class="block text-sm font-medium text-gray-300">Calories Burned (kcal)</label>
                                    <input type="number" id="activity-calories" placeholder="Estimate calories" required class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border border-gray-600 outline-none">
                                </div>
                                <button type="submit" class="w-full p-3 bg-blue-600 hover:bg-blue-700 active:scale-95 transition duration-150 rounded-lg font-bold shadow-md shadow-blue-500/50">
                                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                    Add Log
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Activity Log & BMI -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <!-- BMI Card -->
                        <div class="activity-log-card p-6 rounded-xl shadow-2xl bg-white/10 backdrop-blur-md border border-purple-500/30">
                            <h2 class="text-2xl font-bold mb-4 text-purple-400">Health Metrics</h2>
                            <div class="space-y-3">
                                <p class="text-lg font-medium">BMI: <span class="text-3xl font-extrabold text-cyan-400">${bmi.value}</span></p>
                                <p class="text-md text-gray-300">Category: <span class="font-semibold text-green-400">${bmi.category}</span></p>
                                <p class="text-sm text-gray-400">Weight: ${appData.profile.weight} kg | Height: ${appData.profile.height} cm</p>
                                <button id="view-profile-btn" class="text-sm text-purple-400 hover:underline">Edit Profile</button>
                            </div>
                        </div>

                        <!-- Activity Log Card -->
                        <div class="md:col-span-2 activity-log-card p-6 rounded-xl shadow-2xl bg-white/10 backdrop-blur-md border border-blue-500/30">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-blue-400">Activity Log</h2>
                                <button id="clear-log-btn" class="p-2 text-sm text-red-400 bg-red-500/20 rounded-lg hover:bg-red-500/40 transition duration-150">
                                    Clear All
                                </button>
                            </div>
                            <ul id="activity-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                ${appData.activityLog.length === 0 
                                    ? '<li class="text-gray-400">No activities logged yet.</li>' 
                                    : appData.activityLog.slice().reverse().map(activity => `
                                        <li class="flex justify-between items-center p-3 rounded-lg bg-gray-700/50 hover:bg-gray-600/50 transition duration-100 border border-gray-600">
                                            <div class="flex flex-col">
                                                <span class="font-semibold">${activity.type}</span>
                                                <span class="text-xs text-gray-400">${new Date(activity.date).toLocaleDateString()}</span>
                                            </div>
                                            <div class="text-right">
                                                <span class="block font-bold text-cyan-400">${activity.value} ${activity.type === 'Steps' ? 'steps' : 'min'}</span>
                                                <span class="block text-sm text-purple-400">${activity.calories} kcal</span>
                                            </div>
                                        </li>
                                    `).join('')
                                }
                            </ul>
                        </div>
                    </div>
                `;
            }

            function renderProfileView() {
                return `
                    <div class="max-w-xl mx-auto space-y-8 p-6 bg-white/10 backdrop-blur-md rounded-xl shadow-2xl border border-purple-500/30">
                        <h2 class="text-3xl font-bold text-purple-400 text-center">My Profile & Goals</h2>
                        
                        <!-- Profile Form -->
                        <div class="p-4 rounded-lg bg-white/5 border border-gray-700">
                            <h3 class="text-xl font-semibold mb-3 text-cyan-400">Personal Metrics</h3>
                            <form id="profile-form" class="space-y-4">
                                <div>
                                    <label for="weight" class="block text-sm font-medium text-gray-300">Weight (kg)</label>
                                    <input type="number" id="weight" value="${appData.profile.weight}" required class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border border-gray-600 outline-none">
                                </div>
                                <div>
                                    <label for="height" class="block text-sm font-medium text-gray-300">Height (cm)</label>
                                    <input type="number" id="height" value="${appData.profile.height}" required class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border border-gray-600 outline-none">
                                </div>
                                <div>
                                    <label for="age" class="block text-sm font-medium text-gray-300">Age</label>
                                    <input type="number" id="age" value="${appData.profile.age}" required class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border border-gray-600 outline-none">
                                </div>
                                <div>
                                    <label for="gender" class="block text-sm font-medium text-gray-300">Gender</label>
                                    <select id="gender" class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border border-gray-600 outline-none">
                                        <option value="Male" ${appData.profile.gender === 'Male' ? 'selected' : ''}>Male</option>
                                        <option value="Female" ${appData.profile.gender === 'Female' ? 'selected' : ''}>Female</option>
                                        <option value="Other" ${appData.profile.gender === 'Other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full p-3 bg-purple-600 hover:bg-purple-700 active:scale-95 transition duration-150 rounded-lg font-bold shadow-md shadow-purple-500/50">
                                    Update Profile
                                </button>
                            </form>
                        </div>

                        <!-- Goal Form -->
                        <div class="p-4 rounded-lg bg-white/5 border border-gray-700">
                            <h3 class="text-xl font-semibold mb-3 text-cyan-400">Daily Goals</h3>
                            <form id="goal-form" class="space-y-4">
                                <div>
                                    <label for="daily-steps" class="block text-sm font-medium text-gray-300">Daily Steps Goal</label>
                                    <input type="number" id="daily-steps" value="${appData.goal.dailySteps}" required class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border border-gray-600 outline-none">
                                </div>
                                <div>
                                    <label for="daily-calories" class="block text-sm font-medium text-gray-300">Daily Calorie Burn Goal (kcal)</label>
                                    <input type="number" id="daily-calories" value="${appData.goal.dailyCalories}" required class="w-full p-2 mt-1 rounded-lg bg-gray-700 text-white border border-gray-600 outline-none">
                                </div>
                                <button type="submit" class="w-full p-3 bg-blue-600 hover:bg-blue-700 active:scale-95 transition duration-150 rounded-lg font-bold shadow-md shadow-blue-500/50">
                                    Set New Goals
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            }

            function renderChartsView() {
                return `
                    <div class="max-w-3xl mx-auto space-y-8 p-6 bg-white/10 backdrop-blur-md rounded-xl shadow-2xl border border-cyan-500/30">
                        <h2 class="text-3xl font-bold text-cyan-400 text-center">Activity History</h2>
                        
                        <div class="p-4 rounded-lg bg-white/5 border border-gray-700 chart-container">
                            <h3 class="text-xl font-semibold mb-3 text-purple-400">Steps Over Time</h3>
                            <canvas id="stepsChart"></canvas>
                        </div>

                        <div class="p-4 rounded-lg bg-white/5 border border-gray-700 chart-container">
                            <h3 class="text-xl font-semibold mb-3 text-purple-400">Calories Burned</h3>
                            <canvas id="caloriesChart"></canvas>
                        </div>
                    </div>
                `;
            }

            // --- Calculation Logic ---

            function calculateBMI() {
                const w = appData.profile.weight; // kg
                const h = appData.profile.height / 100; // meters

                if (h === 0 || w === 0) return { value: 'N/A', category: 'N/A' };

                const bmi = w / (h * h);
                const value = bmi.toFixed(1);
                let category;

                if (bmi < 18.5) category = 'Underweight';
                else if (bmi >= 18.5 && bmi <= 24.9) category = 'Healthy Weight';
                else if (bmi >= 25 && bmi <= 29.9) category = 'Overweight';
                else category = 'Obesity';

                return { value, category };
            }

            function calculateProgress(type) {
                const today = new Date().toLocaleDateString();
                let dailyTotal = 0;
                let goalValue = 0;

                if (type === 'steps') {
                    dailyTotal = appData.activityLog
                        .filter(a => new Date(a.date).toLocaleDateString() === today && a.type === 'Steps')
                        .reduce((sum, a) => sum + parseInt(a.value), 0);
                    goalValue = appData.goal.dailySteps;
                } else if (type === 'calories') {
                    dailyTotal = appData.activityLog
                        .filter(a => new Date(a.date).toLocaleDateString() === today && a.type !== 'Steps')
                        .reduce((sum, a) => sum + parseInt(a.calories), 0);
                    goalValue = appData.goal.dailyCalories;
                }

                if (goalValue === 0) return 0;

                const progress = (dailyTotal / goalValue) * 100;
                return Math.min(100, Math.round(progress));
            }

            // --- Setup Event Handlers ---

            function setupNavigation() {
                document.getElementById('nav-dashboard')?.addEventListener('click', () => {
                    currentView = 'dashboard';
                    renderApp();
                });
                document.getElementById('nav-profile')?.addEventListener('click', () => {
                    currentView = 'profile';
                    renderApp();
                });
                document.getElementById('nav-charts')?.addEventListener('click', () => {
                    currentView = 'charts';
                    renderApp();
                });
                document.getElementById('view-profile-btn')?.addEventListener('click', () => {
                    currentView = 'profile';
                    renderApp();
                });
            }

            function setupProfileForms() {
                document.getElementById('profile-form')?.addEventListener('submit', function(e) {
                    e.preventDefault();
                    appData.profile.weight = parseInt(document.getElementById('weight').value);
                    appData.profile.height = parseInt(document.getElementById('height').value);
                    appData.profile.age = parseInt(document.getElementById('age').value);
                    appData.profile.gender = document.getElementById('gender').value;

                    saveFirestoreData();
                    showMessage("Profile updated!");
                    renderApp();
                });
            }
            
            function setupGoalForm() {
                document.getElementById('goal-form')?.addEventListener('submit', function(e) {
                    e.preventDefault();
                    appData.goal.dailySteps = parseInt(document.getElementById('daily-steps').value);
                    appData.goal.dailyCalories = parseInt(document.getElementById('daily-calories').value);
                    
                    saveFirestoreData();
                    showMessage("Goals updated!");
                    renderApp();
                });
            }

            function setupManualEntry() {
                document.getElementById('manual-entry-form')?.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const type = document.getElementById('activity-type').value;
                    const value = document.getElementById('activity-value').value;
                    const calories = document.getElementById('activity-calories').value;

                    if (!value || !calories) {
                        showMessage("Please fill in both value and calories.");
                        return;
                    }

                    appData.activityLog.push({
                        id: Date.now(),
                        type: type,
                        value: parseInt(value),
                        calories: parseInt(calories),
                        date: new Date().toISOString()
                    });

                    saveFirestoreData();
                    showMessage("Activity logged!");
                    
                    // Clear form inputs
                    document.getElementById('activity-value').value = '';
                    document.getElementById('activity-calories').value = '';

                    renderApp();
                });
            }
            
            function setupClearLog() {
                document.getElementById('clear-log-btn')?.addEventListener('click', function() {
                    if (confirmAction("Are you sure you want to clear your entire activity log? This cannot be undone.")) {
                        appData.activityLog = [];
                        saveFirestoreData();
                        showMessage("Activity log cleared.");
                        renderApp();
                    }
                });
            }
            
            function renderCharts() {
                // Prepare data for charts
                const activityData = appData.activityLog;
                const dailyAggregates = {};

                activityData.forEach(item => {
                    const date = new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    if (!dailyAggregates[date]) {
                        dailyAggregates[date] = { steps: 0, calories: 0 };
                    }

                    if (item.type === 'Steps') {
                        dailyAggregates[date].steps += item.value;
                    } else {
                        dailyAggregates[date].calories += item.calories;
                    }
                });

                const labels = Object.keys(dailyAggregates).sort((a, b) => new Date(a) - new Date(b));
                const stepsData = labels.map(date => dailyAggregates[date].steps);
                const caloriesData = labels.map(date => dailyAggregates[date].calories);

                const baseOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e5e7eb' } },
                        title: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    }
                };

                // Steps Chart
                const stepsCtx = document.getElementById('stepsChart')?.getContext('2d');
                if (stepsCtx) {
                    new Chart(stepsCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total Steps',
                                data: stepsData,
                                borderColor: '#06b6d4', // Cyan
                                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                                tension: 0.4,
                                fill: true,
                            }]
                        },
                        options: { ...baseOptions, aspectRatio: 2 }
                    });
                }

                // Calories Chart
                const caloriesCtx = document.getElementById('caloriesChart')?.getContext('2d');
                if (caloriesCtx) {
                    new Chart(caloriesCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Calories Burned',
                                data: caloriesData,
                                backgroundColor: '#a78bfa', // Purple
                                borderRadius: 4,
                            }]
                        },
                        options: { ...baseOptions, aspectRatio: 2 }
                    });
                }
            }
            
            // --- Firebase Initialization ---

            /**
             * Sets up Firebase app, auth, and user listener.
             */
            async function setupFirebaseAndAuth() {
                if (typeof window.firebase === 'undefined') {
                    console.error("Firebase SDK not loaded.");
                    renderApp(); // Render to show error message potentially
                    return;
                }
                
                // Initialize Firebase App
                try {
                    app = window.firebase.initializeApp(firebaseConfig);
                    db = window.firebase.getFirestore(app);
                    auth = window.firebase.getAuth(app);
                    
                    // Auth State Change Listener
                    window.firebase.onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Authentication successful. User ID:", userId);
                            // Check if the user has a username registered in their document
                            await loadFirestoreData();
                        } else {
                            // Initial sign-in (anonymous or custom token)
                            if (initialAuthToken) {
                                console.log("Signing in with custom token...");
                                await window.firebase.signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                console.log("Signing in anonymously...");
                                await window.firebase.signInAnonymously(auth);
                            }
                            // The onAuthStateChanged listener will fire again with the new user object
                        }
                        
                        // Mark auth as ready *after* initial user check and potential sign-in
                        if (!isAuthReady) {
                            isAuthReady = true;
                            // Re-render to show the Auth Screen with proper state/message
                            renderApp();
                        }
                    });

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    showMessage("Failed to connect to backend services.");
                }
            }


            // --- Application Initialization ---

            /**
             * The main initialization function for the app.
             */
            function initApp() {
                generateParticles();
                
                // Set up firebase and auth flow first
                setupFirebaseAndAuth(); 
                
                // Apply initial dark mode styling to static cards (will be updated on render)
                document.querySelector('.daily-goal-card')?.classList.add('bg-white/10', 'backdrop-blur-md', 'border-purple-500/30', 'border');
                document.querySelector('.activity-log-card')?.classList.add('bg-white/10', 'backdrop-blur-md', 'border-blue-500/30', 'border');

                // Initial render will show "Connecting to database..." or Auth Screen
                renderAuthScreen();

                // Ensure window.confirm is explicitly defined as a fallback to avoid errors.
                window.confirm = confirmAction; 
            }

            // Initialize the application when the window loads
            window.onload = initApp;

        })(); // End of IIFE
    </script>
</body>
</html>
