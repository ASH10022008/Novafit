<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovaFit Tracker - Modular Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            transition: background-color 0.5s, color 0.5s;
        }
        /* --- Dark Mode Styles (Default) --- */
        .neon-gradient {
            background: linear-gradient(135deg, #0f172a, #7e22ce, #06b6d4);
            background-size: 600% 600%;
            animation: gradientShift 16s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- Particle System Styles --- */
        #particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: rgba(126, 34, 206, 0.6);
            animation: glow 1s infinite alternate, flow var(--duration) ease-in-out infinite both;
            box-shadow: 0 0 5px rgba(126, 34, 206, 0.8), 0 0 10px rgba(6, 182, 212, 0.5);
            opacity: 0;
        }

        @keyframes glow {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes flow {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            50% {
                transform: translate(var(--flow-x, 0), var(--flow-y, 0)) scale(1.2);
            }
        }
        
        /* Custom style for the circular progress bar */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        /* Style for the floating action button (FAB) */
        #fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        #fab:hover {
            transform: scale(1.05);
        }
        /* Style for the custom dialog/modal */
        dialog {
            border: none;
        }
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .hidden-auth {
            display: none !important;
        }
    </style>
</head>
<body class="neon-gradient text-white flex flex-col items-center p-4 min-h-screen">

    <!-- Particle Container (Z-index 0) -->
    <div id="particles-container"></div>

    <!-- Header & User Info (Z-index 10) -->
    <header class="w-full max-w-4xl flex justify-between items-center py-4 px-2 z-10">
        <h1 class="text-3xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-300">NovaFit</h1>
        <div id="user-info-area" class="flex items-center space-x-2 hidden-auth">
             <!-- Username Display -->
            <span id="username-display" class="font-bold text-lg text-green-300 bg-gray-900/50 p-2 rounded-lg shadow-inner">Guest</span>
            <!-- Logout Button -->
            <button id="logout-btn" class="text-sm text-gray-400 p-2 bg-gray-900/50 rounded-lg shadow-inner hover:bg-gray-800 transition duration-150">
                Logout
            </button>
        </div>
    </header>

    <!-- --- AUTHENTICATION SCREEN (Hidden until needed) --- -->
    <section id="auth-screen" class="w-full max-w-md flex flex-col items-center justify-center flex-grow z-10 hidden-auth">
        <div class="p-8 rounded-xl shadow-2xl backdrop-blur-md bg-gray-800/90 border border-yellow-500/30 w-full text-center">
            <h2 class="text-3xl font-bold mb-6 text-yellow-400">Welcome to NovaFit</h2>
            <p class="text-gray-400 mb-6">Please login or register a unique username to sync your data across devices.</p>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <input type="text" id="username-input" required minlength="3" placeholder="Enter Unique Username" 
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:border-yellow-500 text-white placeholder-gray-500">
                </div>
                
                <p id="auth-message" class="text-sm h-5 text-red-400"></p>
                
                <div class="flex space-x-4 justify-center">
                    <button type="button" id="login-btn" class="flex-1 p-3 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition duration-200 shadow-md">
                        Login
                    </button>
                    <button type="button" id="register-btn" class="flex-1 p-3 bg-green-600 hover:bg-green-700 rounded-lg text-white font-medium transition duration-200 shadow-md">
                        Register
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- --- MAIN APPLICATION DASHBOARD (Hidden until logged in) --- -->
    <main id="app-container" class="w-full max-w-4xl p-2 space-y-6 z-10 hidden-auth">

        <!-- BMI and Calorie Goal Card (Main Dashboard) -->
        <section id="dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <!-- Daily Goal / Progress Card -->
            <div class="daily-goal-card p-6 rounded-xl shadow-2xl backdrop-blur-md bg-white/10 border border-purple-500/30 md:col-span-2">
                <h2 class="text-xl font-semibold mb-4 text-purple-300">Daily Progress</h2>
                <div class="flex items-center space-x-4">
                    <!-- Progress Ring -->
                    <div class="relative w-24 h-24">
                        <svg class="w-full h-full" viewBox="0 0 36 36">
                            <circle class="progress-ring__background text-gray-700" stroke-width="3" stroke="currentColor" fill="transparent" r="15.9155" cx="18" cy="18"/>
                            <circle id="calorie-progress-circle" class="progress-ring__circle" stroke-width="3" stroke="#8b5cf6" fill="transparent" r="15.9155" cx="18" cy="18" stroke-dasharray="0, 100"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="calorie-percentage" class="text-lg font-bold text-purple-300">0%</span>
                        </div>
                    </div>
                    <!-- Stats -->
                    <div class="text-sm">
                        <p class="mb-1">Goal: <span id="goal-calories" class="font-bold text-green-400">2000</span> kcal</p>
                        <p class="mb-1">Consumed: <span id="consumed-calories" class="font-bold text-yellow-400">0</span> kcal</p>
                        <p>Remaining: <span id="remaining-calories" class="font-bold text-red-400">2000</span> kcal</p>
                    </div>
                </div>
            </div>

            <!-- Profile/BMI Card -->
            <div id="profile-card" class="daily-goal-card p-6 rounded-xl shadow-2xl backdrop-blur-md bg-white/10 border border-blue-500/30">
                <h2 class="text-xl font-semibold mb-4 text-blue-300">My Profile</h2>
                <p class="text-sm mb-2">Weight: <span id="display-weight" class="font-bold">--</span> kg</p>
                <p class="text-sm mb-2">Height: <span id="display-height" class="font-bold">--</span> cm</p>
                <p class="text-sm">BMI: <span id="display-bmi" class="font-bold text-green-400">--</span></p>
                <button onclick="document.getElementById('profile-modal').showModal()" class="mt-4 w-full p-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition duration-200 shadow-md">Edit Profile</button>
            </div>
        </section>

        <!-- Activity Log Card -->
        <section class="activity-log-card p-6 rounded-xl shadow-2xl backdrop-blur-md bg-white/10 border border-teal-500/30">
            <h2 class="text-xl font-semibold mb-4 text-teal-300">Today's Activity Log</h2>
            <div id="activity-log" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                <!-- Log entries will be inserted here -->
                <p id="empty-log-message" class="text-gray-500 italic">No activities logged yet.</p>
            </div>
            <button id="clear-log-btn" class="mt-4 p-2 bg-red-600 hover:bg-red-700 rounded-lg text-white font-medium transition duration-200 shadow-md hidden">Clear Today's Log</button>
        </section>

    </main>
    
    <!-- Floating Action Button (FAB) for Manual Entry (Z-index 20) -->
    <button id="fab" onclick="document.getElementById('entry-modal').showModal()" class="p-4 rounded-full bg-green-500 text-white shadow-lg hover:bg-green-600 z-20 hidden-auth">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <!-- Modals (Z-index 30) -->

    <!-- Manual Entry Modal -->
    <dialog id="entry-modal" class="p-6 rounded-xl shadow-2xl backdrop-blur-md bg-gray-800/90 text-white border border-green-500/30 w-11/12 md:w-1/3 z-30">
        <h3 class="text-2xl font-bold mb-4 text-green-400">Log Activity</h3>
        <form id="entry-form" class="space-y-4">
            <div>
                <label for="food-item" class="block text-sm font-medium mb-1">Item / Activity</label>
                <input type="text" id="food-item" required class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-green-500 text-white">
            </div>
            <div>
                <label for="calorie-count" class="block text-sm font-medium mb-1">Calories (kcal)</label>
                <input type="number" id="calorie-count" required min="1" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-green-500 text-white">
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="document.getElementById('entry-modal').close()" class="p-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white">Cancel</button>
                <button type="submit" class="p-2 bg-green-600 hover:bg-green-700 rounded-lg text-white font-medium">Add Entry</button>
            </div>
        </form>
    </dialog>

    <!-- Profile/Goal Modal -->
    <dialog id="profile-modal" class="p-6 rounded-xl shadow-2xl backdrop-blur-md bg-gray-800/90 text-white border border-blue-500/30 w-11/12 md:w-1/3 z-30">
        <h3 class="text-2xl font-bold mb-4 text-blue-400">Edit Profile & Goals</h3>
        
        <form id="profile-form" class="space-y-4 mb-6 p-4 border border-gray-700 rounded-lg">
            <h4 class="text-lg font-semibold text-blue-300">Body Metrics</h4>
            <div>
                <label for="weight-input" class="block text-sm font-medium mb-1">Weight (kg)</label>
                <input type="number" id="weight-input" required min="1" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-blue-500 text-white">
            </div>
            <div>
                <label for="height-input" class="block text-sm font-medium mb-1">Height (cm)</label>
                <input type="number" id="height-input" required min="1" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-blue-500 text-white">
            </div>
            <button type="submit" class="w-full p-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white font-medium transition duration-200">Save Metrics</button>
        </form>

        <form id="goal-form" class="space-y-4 p-4 border border-gray-700 rounded-lg">
            <h4 class="text-lg font-semibold text-purple-300">Calorie Goal</h4>
            <div>
                <label for="goal-input" class="block text-sm font-medium mb-1">Daily Calorie Goal (kcal)</label>
                <input type="number" id="goal-input" required min="500" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 focus:border-purple-500 text-white">
            </div>
            <button type="submit" class="w-full p-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-medium transition duration-200">Set Goal</button>
        </form>
        
        <div class="flex justify-end mt-4">
            <button type="button" onclick="document.getElementById('profile-modal').close()" class="p-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white">Close</button>
        </div>
    </dialog>

    <script type="module">
        // --- 1. Master Configuration Switch ---
        const USE_CLOUD_STORAGE = true; 

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        if (USE_CLOUD_STORAGE) {
            setLogLevel('debug');
        }

        // --- Application Data Model (Default State) ---
        const DEFAULT_APP_DATA = {
            profile: {
                weight: 0,
                height: 0,
                goalCalories: 2000,
            },
            activityLog: []
        };
        let appData = { ...DEFAULT_APP_DATA };
        
        // Key used for storing the user's chosen username locally
        const PERSISTENT_USERNAME_KEY = 'novaFitUsername';
        
        let currentUsername = null;
        let currentFirebaseUID = null; // The secure ID used for private data access
        
        // --- UI Element References ---
        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');
        const fabButton = document.getElementById('fab');
        const userInfoArea = document.getElementById('user-info-area');
        const usernameDisplay = document.getElementById('username-display');
        const authMessage = document.getElementById('auth-message');
        const usernameInput = document.getElementById('username-input');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');


        // --- 2. LocalStorage Implementation (Simple, Instant) ---
        // (Simplified - cloud is the focus)
        const LocalStorageDataStore = (function() {
            const LOCAL_STORAGE_KEY = 'novaFitData';
            // ... (rest of LocalStorageDataStore remains the same)
            function loadInitialData() {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                return storedData ? JSON.parse(storedData) : { ...DEFAULT_APP_DATA };
            }

            return {
                init: (callback) => {
                    const data = loadInitialData();
                    callback(data);
                    // In LocalStorage mode, we assume logged in immediately
                    setAppState('dashboard'); 
                },
                saveData: (data) => {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
                    appData = data;
                    renderApp(); 
                    console.log("Data saved to Local Storage.");
                },
                getUsername: () => 'LOCAL_USER',
                logout: () => {
                    console.log("Logged out from Local Storage mode.");
                }
            };
        })();


        // --- 3. Firebase Firestore Implementation (Complex, Real-time) ---
        const FirestoreDataStore = (function() {
            let db, auth;
            let unsubscribeListener = null; 
            let isAuthReady = false;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            // Paths for data storage
            function getPublicUserMapPath(username) {
                // Public collection mapping chosen username to secure Firebase UID
                return `artifacts/${appId}/public/user_map/${username.toLowerCase()}`;
            }
            function getPrivateUserDocumentPath(uid) {
                // Private collection storing fitness data
                return `artifacts/${appId}/users/${uid}/data/userDocument`;
            }

            // --- Core Sync Logic ---
            function startRealtimeSync(uid, dataUpdateCallback) {
                if (!db || !uid) return;

                // 1. Clear any existing listener
                if (unsubscribeListener) {
                    unsubscribeListener();
                    unsubscribeListener = null;
                }
                
                // 2. Start new listener on the target UID's private document
                const docPath = getPrivateUserDocumentPath(uid);
                console.log(`Starting sync for Data UID: ${uid}`);

                unsubscribeListener = onSnapshot(doc(db, docPath), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const remoteData = docSnapshot.data();
                        const updatedData = {
                            profile: { ...DEFAULT_APP_DATA.profile, ...remoteData.profile },
                            activityLog: Array.isArray(remoteData.activityLog) ? remoteData.activityLog : []
                        };
                        dataUpdateCallback(updatedData);
                    } else {
                        // Document doesn't exist for this UID, initialize and save defaults
                        dataUpdateCallback(DEFAULT_APP_DATA); 
                        FirestoreDataStore.saveData(DEFAULT_APP_DATA); 
                    }
                }, (error) => {
                    console.error("Error setting up real-time listener:", error);
                });
            }
            
            // --- Core Authentication / Setup ---
            async function setupFirebaseAuth() {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // 1. Establish the underlying Firebase security session (required for security rules)
                    let authPromise;
                    if (initialAuthToken) {
                        authPromise = signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        authPromise = signInAnonymously(auth);
                    }
                    
                    const userCredential = await authPromise;
                    currentFirebaseUID = userCredential.user.uid;
                    isAuthReady = true;
                    console.log(`Firebase Auth Ready. Base UID: ${currentFirebaseUID}`);
                    
                    // 2. Try to automatically log in the user if a username is stored
                    const storedUsername = localStorage.getItem(PERSISTENT_USERNAME_KEY);
                    if (storedUsername) {
                        await loginUser(storedUsername);
                    } else {
                        // If no username is stored, show the login screen
                        setAppState('auth-screen');
                    }

                } catch (error) {
                    console.error("Firebase setup or authentication failed:", error);
                    authMessage.textContent = 'Auth error. Check console.';
                    setAppState('auth-screen');
                }
            }
            
            // --- User Mapping Functions ---
            
            async function checkUsername(username) {
                const docRef = doc(db, getPublicUserMapPath(username));
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data().firebaseUID : null;
            }

            async function mapUsernameToUID(username, uid) {
                try {
                    const docRef = doc(db, getPublicUserMapPath(username));
                    await setDoc(docRef, { firebaseUID: uid });
                    console.log(`Username ${username} mapped to UID ${uid}.`);
                    return true;
                } catch (error) {
                    console.error("Error mapping username:", error);
                    return false;
                }
            }

            // --- Public Login/Register/Logout ---

            async function registerUser(username, dataUpdateCallback) {
                authMessage.textContent = 'Checking username...';
                
                // 1. Check if username is already taken
                const existingUID = await checkUsername(username);
                if (existingUID) {
                    authMessage.textContent = 'Error: That username is already taken.';
                    return;
                }
                
                // 2. Map the new username to the current, anonymous Firebase UID
                const success = await mapUsernameToUID(username, currentFirebaseUID);
                if (success) {
                    // 3. Persist the username and log the user in
                    localStorage.setItem(PERSISTENT_USERNAME_KEY, username);
                    currentUsername = username;
                    startRealtimeSync(currentFirebaseUID, dataUpdateCallback);
                    setAppState('dashboard');
                } else {
                    authMessage.textContent = 'Registration failed. Try again.';
                }
            }

            async function loginUser(username, dataUpdateCallback) {
                authMessage.textContent = 'Logging in...';
                
                // 1. Look up the secure Firebase UID associated with the username
                const targetUID = await checkUsername(username);

                if (!targetUID) {
                    authMessage.textContent = 'Error: Username not found. Please Register.';
                    return;
                }

                // 2. Set the current data target to the retrieved UID
                localStorage.setItem(PERSISTENT_USERNAME_KEY, username);
                currentUsername = username;
                
                // NOTE: We now use the TARGET UID for all data operations, even if it's different 
                // from the current device's anonymous session UID.
                currentFirebaseUID = targetUID; 
                
                // 3. Start sync on the target UID
                startRealtimeSync(currentFirebaseUID, dataUpdateCallback);
                setAppState('dashboard');
            }

            return {
                async init(dataUpdateCallback) {
                    setupFirebaseAuth();
                },

                async saveData(data) {
                    if (!currentFirebaseUID) {
                        console.warn("User not logged in. Cannot save data.");
                        return;
                    }
        
                    const docPath = getPrivateUserDocumentPath(currentFirebaseUID);
        
                    try {
                        await setDoc(doc(db, docPath), data);
                        console.log("Data saved successfully to Firestore.");
                    } catch (error) {
                        console.error("Error saving data:", error);
                    }
                },
                
                getUsername: () => currentUsername,
                
                register: (username) => registerUser(username, handleDataUpdate),
                login: (username) => loginUser(username, handleDataUpdate),
                
                logout: () => {
                    localStorage.removeItem(PERSISTENT_USERNAME_KEY);
                    currentUsername = null;
                    currentFirebaseUID = null;
                    if (unsubscribeListener) {
                        unsubscribeListener();
                        unsubscribeListener = null;
                    }
                    setAppState('auth-screen');
                    authMessage.textContent = 'Logged out successfully.';
                    // Clear app data locally
                    handleDataUpdate(DEFAULT_APP_DATA);
                    // Reload the page to reset the anonymous session if needed for a fresh start
                    // window.location.reload(); 
                }
            };
        })();


        // --- 4. Select the Active Data Store ---
        const DataStore = USE_CLOUD_STORAGE ? FirestoreDataStore : LocalStorageDataStore;


        // --- UI State Management ---
        function setAppState(state) {
            if (state === 'dashboard') {
                authScreen.classList.add('hidden-auth');
                appContainer.classList.remove('hidden-auth');
                fabButton.classList.remove('hidden-auth');
                userInfoArea.classList.remove('hidden-auth');
                usernameDisplay.textContent = DataStore.getUsername();
            } else if (state === 'auth-screen') {
                authScreen.classList.remove('hidden-auth');
                appContainer.classList.add('hidden-auth');
                fabButton.classList.add('hidden-auth');
                userInfoArea.classList.add('hidden-auth');
            }
        }


        // --- CORE APPLICATION LOGIC ---
        function calculateBMI() {
            const weight = appData.profile.weight;
            const heightMeters = appData.profile.height / 100;
            if (weight > 0 && heightMeters > 0) {
                const bmi = weight / (heightMeters * heightMeters);
                return bmi.toFixed(2);
            }
            return '--';
        }

        function confirmAction(message) {
             console.warn(`Assuming confirmation for action: ${message}`);
             return true; 
        }

        function renderApp() {
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = appData.activityLog.filter(entry => entry.date === today);
            const totalConsumed = todayEntries.reduce((sum, entry) => sum + entry.calories, 0);
            const goal = appData.profile.goalCalories || 2000;
            
            // 1. Profile and BMI
            document.getElementById('display-weight').textContent = appData.profile.weight > 0 ? `${appData.profile.weight} kg` : '--';
            document.getElementById('display-height').textContent = appData.profile.height > 0 ? `${appData.profile.height} cm` : '--';
            document.getElementById('display-bmi').textContent = calculateBMI();
            
            // Set form inputs
            if (document.getElementById('weight-input')) document.getElementById('weight-input').value = appData.profile.weight || '';
            if (document.getElementById('height-input')) document.getElementById('height-input').value = appData.profile.height || '';
            if (document.getElementById('goal-input')) document.getElementById('goal-input').value = goal;

            // 2. Daily Progress
            const remaining = goal - totalConsumed;
            const percentage = Math.min(100, (totalConsumed / goal) * 100);
            const circumference = 2 * Math.PI * 15.9155;
            const dashoffset = circumference - (percentage / 100) * circumference;

            document.getElementById('goal-calories').textContent = goal;
            document.getElementById('consumed-calories').textContent = totalConsumed;
            document.getElementById('remaining-calories').textContent = Math.max(0, remaining);
            document.getElementById('calorie-percentage').textContent = `${Math.round(percentage)}%`;
            
            const progressCircle = document.getElementById('calorie-progress-circle');
            
            if (progressCircle) {
                progressCircle.style.strokeDasharray = `${circumference}, ${circumference}`;
                progressCircle.style.strokeDashoffset = dashoffset;
                
                // Set circle color based on progress
                if (remaining < 0) {
                    progressCircle.setAttribute('stroke', '#ef4444'); // red
                } else if (percentage >= 100) {
                    progressCircle.setAttribute('stroke', '#10b981'); // emerald/green
                } else {
                    progressCircle.setAttribute('stroke', '#8b5cf6'); // purple
                }
            }

            // 3. Activity Log
            const logContainer = document.getElementById('activity-log');
            const emptyLogMessage = document.getElementById('empty-log-message');
            const clearLogBtn = document.getElementById('clear-log-btn');
            
            if (logContainer) logContainer.innerHTML = '';
            
            if (todayEntries.length === 0) {
                if (emptyLogMessage) emptyLogMessage.style.display = 'block';
                if (clearLogBtn) clearLogBtn.classList.add('hidden');
            } else {
                if (emptyLogMessage) emptyLogMessage.style.display = 'none';
                if (clearLogBtn) clearLogBtn.classList.remove('hidden');

                todayEntries.sort((a, b) => b.id - a.id); // Show newest first
                
                todayEntries.forEach(entry => {
                    const logItem = document.createElement('div');
                    logItem.className = 'flex justify-between items-center p-3 bg-gray-700/50 rounded-lg shadow-sm';
                    logItem.innerHTML = `
                        <p class="text-sm font-medium">${entry.item}</p>
                        <div class="flex items-center space-x-3">
                            <span class="text-xs font-bold text-yellow-300">${entry.calories} kcal</span>
                            <button data-id="${entry.id}" class="remove-entry text-red-400 hover:text-red-500 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    `;
                    if (logContainer) logContainer.appendChild(logItem);
                });
                
                // Re-attach listeners for the new remove buttons
                document.querySelectorAll('.remove-entry').forEach(button => {
                    button.onclick = handleRemoveEntry;
                });
            }
        }

        // --- Data Update Handler ---
        function handleDataUpdate(newData) {
            appData = newData;
            renderApp();
        }

        // --- Handlers ---
        
        function handleProfileSubmit(e) {
            e.preventDefault();
            const weight = parseFloat(document.getElementById('weight-input').value);
            const height = parseFloat(document.getElementById('height-input').value);

            appData.profile.weight = weight;
            appData.profile.height = height;
            
            DataStore.saveData(appData);
            document.getElementById('profile-modal').close();
        }

        function handleGoalSubmit(e) {
            e.preventDefault();
            const goal = parseInt(document.getElementById('goal-input').value, 10);
            
            appData.profile.goalCalories = goal;
            
            DataStore.saveData(appData);
            document.getElementById('profile-modal').close();
        }

        function handleEntrySubmit(e) {
            e.preventDefault();
            const item = document.getElementById('food-item').value.trim();
            const calories = parseInt(document.getElementById('calorie-count').value, 10);
            const today = new Date().toISOString().split('T')[0];

            if (item && calories > 0) {
                const newEntry = {
                    id: Date.now(), 
                    item: item,
                    calories: calories,
                    date: today
                };
                appData.activityLog.push(newEntry);
                
                DataStore.saveData(appData);
                
                document.getElementById('entry-form').reset();
                document.getElementById('entry-modal').close();
            }
        }

        function handleRemoveEntry(e) {
            const id = parseInt(e.currentTarget.dataset.id, 10);
            
            if (confirmAction('Are you sure you want to remove this entry?')) {
                appData.activityLog = appData.activityLog.filter(entry => entry.id !== id);
                DataStore.saveData(appData);
            }
        }

        function handleClearLog() {
            if (confirmAction('Are you sure you want to clear ALL log entries for today?')) {
                const today = new Date().toISOString().split('T')[0];
                appData.activityLog = appData.activityLog.filter(entry => entry.date !== today);
                DataStore.saveData(appData);
            }
        }
        
        // --- AUTH Handlers (NEW) ---
        function handleAuthAction(actionType) {
            const username = usernameInput.value.trim().toLowerCase();
            authMessage.textContent = ''; 

            if (!username || username.length < 3) {
                authMessage.textContent = 'Username must be at least 3 characters.';
                return;
            }

            if (actionType === 'login') {
                DataStore.login(username);
            } else if (actionType === 'register') {
                DataStore.register(username);
            }
        }

        function handleLogout() {
            if (confirmAction('Are you sure you want to logout?')) {
                DataStore.logout();
            }
        }


        // --- Setup Functions ---

        function setupProfileForms() {
            document.getElementById('profile-form').onsubmit = handleProfileSubmit;
        }
        
        function setupManualEntry() {
            document.getElementById('entry-form').onsubmit = handleEntrySubmit;
        }

        function setupGoalForm() {
            document.getElementById('goal-form').onsubmit = handleGoalSubmit;
        }

        function setupClearLog() {
            document.getElementById('clear-log-btn').onclick = handleClearLog;
        }
        
        function setupAuthListeners() {
            loginBtn.onclick = () => handleAuthAction('login');
            registerBtn.onclick = () => handleAuthAction('register');
            logoutBtn.onclick = handleLogout;
        }


        // --- Particle System Logic (Unchanged) ---
        function generateParticles() {
            const container = document.getElementById('particles-container');
            if (!container) return;
            const numParticles = 30; 
            const duration = 15;
            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${Math.random() * 100}vw`;
                particle.style.top = `${Math.random() * 100}vh`;
                const size = Math.random() * 3 + 2; 
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.setProperty('--duration', `${Math.random() * 10 + duration}s`);
                particle.style.animationDelay = `-${Math.random() * duration}s, -${Math.random() * duration}s`;
                const flowX = Math.random() * 200 - 100;
                const flowY = Math.random() * 200 - 100;
                particle.style.setProperty('--flow-x', `${flowX}px`);
                particle.style.setProperty('--flow-y', `${flowY}px`);
                container.appendChild(particle);
            }
        }

        function initApp() {
            // Initialize all form/button listeners
            setupProfileForms();
            setupManualEntry();
            setupGoalForm();
            setupClearLog();
            setupAuthListeners(); // NEW: Setup login/register listeners
            generateParticles(); 

            // Initialize the data store and authentication flow
            DataStore.init(handleDataUpdate); 
        }

        window.onload = initApp;
        window.confirm = confirmAction; 

    </script>
</body>
</html>
